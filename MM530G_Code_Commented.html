
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOB, COB, and BG Predictions - Nightscout</title>
    <link href="/images/round1.png" rel="icon" id="favicon" type="image/png" />
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <style type="text/css">
        table tr td {
            white-space: nowrap;
        }
    </style>
    <script src="/bower_components/angularjs/angular.min.js"></script>
    <script type="text/javascript">
        'use strict';

        // I don't know what this does
        var app = angular.module('ns-treatments', []);

        // I don't know what this does
        app.controller('TreatmentsController', function ($scope, $http, $timeout, visibility) {
            var pageIsHidden = false;

            // I am not sure what this does
            function update() {
                console.info("update called");
                if (pageIsHidden) {
                    console.info('Not updating, since page is hidden');
                } else {
                    console.info('Updating, since page is visible');
                    $http.get('/api/v1/treatments').success(function(treatments) {

                        // retrieve the object treatments, from MongoDB
                        // Components of the object include:

                        // treatment.created_at = time and date of treatment, from indices 0 to 99. Date is in 'short' format. The most recent value
                        // is the  first indice

                        // treatment.insulin is the bolus dose [Units?] at treatment.created_at, from indices 0 to 99

                        // treatment.carbs is the amoint of carbohydates consumed [grams or g] at time treatment.created_at

                        $scope.treatments = treatments.slice(0, 100);


                        // invoking function iobTotal, insulin on board total, in [Units] or [U] values, using the function iobTotal, for the 
                        // array treatments from indices 0 to 99, from MongoDB. treatment.insulin [U] and treatment.created_at [date] are inputs
                        $scope.iobTotal = iobTotal(treatments.slice(0, 100));

                        // creating vector for putting the object treatments, from indices 0 to 99 in reverse order
                        var treatments_r = treatments.slice(0, 100);

                        // The object treatments, from indices 0 to 99 in reverse order in terms of indices of $scope.
                        // treatments. This puts the most recent treatments as the final indices, near indice 99.
                        treatments_r.reverse();

                        // invoking function cobTotal, total carbs on board, in [grams] or [g], values for the array treatments_r, which is 
                        // treatments in reverse order, for indices 0 to 99. 
                        $scope.cobTotal = cobTotal(treatments_r);

                        // invoking function carbImpact, which determines the effect of carbohydrates on blood glucose in [mg/dL], where rawCarbImpact
                        // ($scope.cobTotal.carbImpact) [mg/dL/min] and insulinImpact ($scope.iobTotal.activity) [mg/dL/min] are inputs
                        $scope.carbImpact = carbImpact($scope.cobTotal.carbImpact, $scope.iobTotal.activity);

                        // invoking function lookbackCarbs, to find the aggregate (total) amount of carbs [grams] or [g]
                        // consumed in the past 8 hours, with treatments_r, in [grams] or [g] and 8 [hours] are inputs
                        $scope.eightHourCarbs = lookbackCarbs(treatments_r, 8);

                        // invoking function lookbackCarbs, to find the aggregate (total) amount of carbs [grams] or [g]
                        // consumed in the past 3 hours, with treatments_r, in [grams] or [g] and 3 [hours] are inputs
                        $scope.threeHourCarbs = lookbackCarbs(treatments_r, 3);


                        // invoking function lookbackInsulin, to find the aggregate (total) amount of insulin [Units] or [U]
                        // given in the past 3 hours, with treatments_r, in [Units] or [U] and 3 [hours] are inputs
                        $scope.threeHourInsulin = lookbackInsulin(treatments_r, 3);


                        // retrieves information from the JSON file
                        // current is the sensor glucose values
                        $http.get('/api/v1/entries/current.json').success(function(current) {

                            // retrieves the most recent sensor glucose value from MongoDB
                            $scope.current = current[0];

                // outputs data about the most recent sensor glucose value to the web console
                console.info(current[0]);

                            // invoking function bgPredictions, to find the predicted BG [mg/dL] 2 hours from the current time. Inputs are 
                            // treatments (date "short format", bolus dose [U], and carbohydrates [grams]) and the current sensor value [mg/dL]
                            $scope.bgPredictions = bgPredictions(treatments, current[0]);
                        });
                    });

                    // retrieve profile from MongoDB for insulin sensitivity factor (ISF) [mg/dL/U] aka "sens", carbohydrate ratio [g/U] aka 
                    // "carbratio", and carbohydrates absorbed per hour [g/hour] aka "carbs_hr"
                    $http.get('/api/v1/profile').success(function(profile) {
                        // retrieves indices 0 to 499 of profile settings
                        $scope.profile = profile.slice(0, 500);
			//console.info(profile);
                    });
                }
            }

            // I don't know what this is, but it doesn't look too important to me
            $scope.$on('visibilityChanged', function(event, isHidden) {
                console.info('changed pageIsHidden to ' + isHidden);
                pageIsHidden = isHidden;
                if (!pageIsHidden) update();
            });

            // I don't know what this is, but it doesn't look too important to me
            function startUpdateCycle() {
                update();
                // I don't know what this is but I think this updates the NightScout page every 20 seconds
                $timeout(startUpdateCycle, 20 * 1000);
            }

            startUpdateCycle();

            // This function displays self-monitored BG values (fingerstick), in [mg/dL]
            // It's not that important.
            $scope.glucoseDisplay = function(treatment) {
                if (treatment.glucose)
                    return treatment.glucose + (treatment.glucoseType ? ' (' + treatment.glucoseType + ')' : '');
                else
                    return '';
            }

            // This function displays the total insulin on board (IOB) [U] or [Units], which is how much insulin [Units] that can potentially affect 
            // blood glucose [mg/dL] with input treatments (Insulin on Board) [U], and time [min]
            function iobTotal(treatments, time) {
                //console.info("iobTotal called");

                // Local variable iob (insulin on board), which is how much insulin [Units] that can potentially affect blood glucose [mg/dL, is 
                // initialized
                var iob= 0;

                // Local variable activity [mg/dL/min], blood glucose impact of the active insulin in units
                var activity = 0;

                // if treatments = 0, then return a null value for iob, insulin on board, [Units] 
                if (!treatments) return {};

                // Invoking a function for each treatment
                treatments.forEach(function(treatment) {

                    // Local variable tIOB, total insulin on board, [U]
                    var tIOB = $scope.iob(treatment, time);

                    // if tIOB and tIOB.iobContrib both have values that are not 0
                    // then total iob [U] is added up from each treatment
                    if (tIOB && tIOB.iobContrib) iob += tIOB.iobContrib;

                    // if tIOB and tIOB.activityContrib both have values that are not 0
                    // then total activity [mg/dL/min] is added up from each treatment
                    if (tIOB && tIOB.activityContrib) activity += tIOB.activityContrib;
                });

                // returns the resulting values
                return {

                // iob [U] is returned back to iobTotal
                    iob: iob,

                    // activity [mg/dL/min] is returned back to iobTotal
                    activity: activity

                    // end of function
                };
            }
            // This function finds all of the carbohydrates [grams] consumed from the input array treatments (carbohydrates) [grams],
            // lookbackHours [hours], which is the amount of hours to look back, and time [milliseconds] which is the current time
            // for a specified time, lookbackHours
            function lookbackCarbs(treatments, lookbackHours, time) {

                // if there are no treatments, send null values for lookbackCarbs [grams] or [g], to outside the function and update to MongoDB
                if (!treatments) return {};

                // if no time is provided as input for the lookbackCarbs function, retrieve the current time and date
                if (typeof time === 'undefined') {
                    var time = new Date();
                }

                // Local variable that assigns the current time and date to startCounting
                var startCounting = new Date();

                // Local variable that assigns the current time in [hours] minus lookbackHours [hours] to startCounting
                // this is the initial point in time to lookback to, in [hours]
                startCounting = startCounting.setHours(startCounting.getHours() - lookbackHours);

                // Local variable that assigns the value 0 to lookbackCarbs [grams]
                var lookbackCarbs = 0;

                // Anonymous function that is passed to treatments.forEach , which will determine the amount of carbs consumed for 
                // lookbackCarbs [grams], based on lookbackHours [hours]
                treatments.forEach(function(treatment) {

                    // Local variable that assigns a date with time object to carbTime, to let us work with dates 
                    var carbTime = new Date(treatment.created_at);

                    // if treatment.carbs [grams] AND carbTime [date and time] are both greater than both startCounting [hours] AND
                    // AND carbTime [date and time] is less than time (current) [date and time]
                    if(treatment.carbs && carbTime > startCounting && carbTime < time ) {

                        // lookbackCarbs is the summation of all of the treatment.carb values within the timeframe 
                        // of the difference of the current time, time minus lookbackHours and the current time, time
                        lookbackCarbs = lookbackCarbs + parseInt(treatment.carbs);
                    }
                });

                // sends the value of lookbackCarbs [grams], the amount of carbohydrates consumed in a sepcified time to outside the function which 
                // gets updated to MongoDB
                return { lookbackCarbs: lookbackCarbs };

                // end of function
            }

            // This function finds all of the insulin [Units] administered from the input array treatments (insulin) [Units],
            // lookbackHours [hours], which is the amount of hours to look back, and time [milliseconds] which is the current time
            // for a specified time, lookbackHours
            function lookbackInsulin(treatments, lookbackHours, time) {

                // if there are no treatments, send null values for lookbackInsulin [Units] or [U] to outside the function which gets updated in
                // MongoDB
                if (!treatments) return {};

                // if no time is provided as input for the lookbackCarbs function, retrieve the current time and date
                if (typeof time === 'undefined') {
                    var time = new Date();
                }

                // Local variable that assigns the current time and date to startCounting
                var startCounting = new Date();

                // Local variable that assigns the current time in [hours] minus lookbackHours [hours] to startCounting
                // this is the initial point in time to lookback to, in [hours]
                startCounting = startCounting.setHours(startCounting.getHours() - lookbackHours);

                // Local variable that assigns the value 0 to lookbackInsulin [Units]
                var lookbackInsulin = 0;

                // Anonymous function that is passed to treatments.forEach , which will determine the amount of insulin administered for 
                // lookbackInsulin [Units], in the past lookbackHours [hours]
                treatments.forEach(function(treatment) {

                    // Local variable that assigns a date with time object to bolusTime, which is the time that insulin is administered in units
                    // to let us work with dates
                    var bolusTime = new Date(treatment.created_at);

                    // if treatment.insulin [Units] AND bolusTime [date and time] are both greater than both startCounting [hours] AND
                    // AND bolusTime [date and time] is less than time (current) [date and time]
                    if(treatment.insulin && bolusTime > startCounting && bolusTime < time ) {

                        // lookbackInsulin is the summation of all of the treatment.insulin values within the time frame of the difference of the 
                        // current time, time minus lookbackHours and the current time, time
                        lookbackInsulin = lookbackInsulin + parseFloat(treatment.insulin);
                    }
                });

                 // sends the value of lookbackInsulin [Units] to outside the function which gets updated to MongoDB
                return { lookbackInsulin: lookbackInsulin };
            }

            // Function cobTotal (total carbohydrates on board) determines the amount of active carbohydrates [grams] to be absorbed/eliminated
            // by the body. This is a representation of potential influence of carbohydrates [grams] on blood glucose [mg/dL]
            //decayedBy [minutes], isDecaying (flag to determine if carbohydrates are being eliminated from the system [0 or 1], carbs_hr, carbImpact, cob
            function cobTotal(treatments, time) {
                //console.info("cobTotal called");
                var cob=0;

                // if there are no treatments, send null values for cobTotal [grams] or [g] to outside the function which gets updated in
                // MongoDB
                if (!treatments) return {};

                // if no time is provided as input for the lookbackCarbs function, retrieve the current time and date
                if (typeof time === 'undefined') {
                    var time = new Date();
                }

                // Local variable isDecaying is a flag to determine whether or not carbohydrates are being absorbed/eliminated from the system
                var isDecaying = 0;

                // Local variable lastDecayedby that is initialized by assigning an arbitrary date 
                var lastDecayedBy = new Date("1/1/1970");

                // carbs_hr, [grams/hour] is the amount of carbohydrates that are absorbed/eliminated from the carbohydrates on board function per hour
                var carbs_hr = $scope.profile[0].carbs_hr;


                // Anonymous function that is passed to treatments.forEach, which will determine the total amount of carbohydrates on board (tCOB) 
                // [grams] that can possibly affect blood glucose in [mg/dL], for future calculations
                treatments.forEach(function(treatment) {

                    // if treatment.carbs [grams] has values that are not 0, then the code inside the braces executes
                    if(treatment.carbs) {

                        // Local variable tCOB (total carbohydrates on board) [grams] is assigned the result of invoking the anonymous function cob 
                        //(carbs on board) with inputs treatment with carbohydrates [grams], lastDecayedBy [date and time], and the current time, time
                        // returned values are initialCarbs [grams] consumed when eating, decayedBy which is the [time] used to determine the 
                        // absorption/elimination of carbohydrates, isDecaying is a flag to determine if a point in time has been reached where 
                        // carbohydrates are being absorbed and eliminated from the system, carbTime is the date and time of when the person initially
                        // consumed the carbohydrates
                        var tCOB = $scope.cob(treatment, lastDecayedBy, time);

                        // if tCOB (total carbohydrates on board) [grams] is not 0, then the code inside the braces executes
                        if (tCOB) {

                            // The object tCOB.decayedBy [milliseconds], which comes from the cob (carbohydrates on board [grams]) function is 
                            // assigned to lastDecayedBy. This represents the time to decay (eliminate/absorb) the carbohydrates consumed at a certain 
                            // time.
                            lastDecayedBy = tCOB.decayedBy;

                            // if the object tCOB.carbsleft, which is the carbs left to be absorbed [grams], has a value that is not 9
                            if (tCOB.carbsleft) {

                                // Declare local variable carbsleft, the carbs left to be absorbed, and sum up the values (indices) of tCOB.carbsleft
                                var carbsleft = + tCOB.carbsleft;
                            }
                        }
                        // decaysin_hr [hours] is the time required to decay (absorb/eliminate) carbohydrates on board, which 
                        // affect blood glucose [mg/dL]
                        var decaysin_hr = (lastDecayedBy-time)/1000/60/60;

                        // if decaysin_hr [hours] is not 0, then the code in the braces executes
                        if (decaysin_hr > 0) {

                            // cob, carbohydrates on board [grams], is the amount of carbohydrates to be absorbed at a certain time point
                            // in the GI system
                            cob = Math.min(tCOB.initialCarbs, decaysin_hr * carbs_hr);

                            // flag isDecaying is set
                            isDecaying = tCOB.isDecaying;
                        }
                        else { 
                            // if decaysin_hr equals 0, then code in this brace executes
                            cob = 0;
                        }
                    }
                });

                // Local variable sens, which is the insulin sensitivity factor [mg/dL/U], which is the rate at which 
                // insulin affects blood glucose [mg/dL] this is retreived from the profile information from Care Portal, stored in MongoDB
                var sens = $scope.profile[0].sens;

                // Local variable carbratio, which is the rate at which insulin is taken [grams of carbs/Unit of insulin] [grams/U] for the amount of 
                // carbohydrates consumed. This is retrieved from the profile information from Care Portal, stored in MongoDB
                var carbratio = $scope.profile[0].carbratio;

                // Local variable carbImpact, which is the expected (current) inpact in blood glucose points per minute [mg/dL/min] that occurs
                // when the decay (absorption) happens
                var carbImpact = isDecaying*sens/carbratio*carbs_hr/60;
                return {
                    // sends the value decayedBy, the time to decay/absorb/eliminate carbohydrates from the system, [millisenconds] to
                    // outside the function, which gets updated in MongoDB
                    decayedBy: lastDecayedBy,
                    
                    // sends the value isDecaying, which is a flag with a value of 0 or 1, to outside the function, which gets updated in
                    // MongoDB
                    isDecaying: isDecaying,

                    // sends the value carbs_hour, the amount of carbs on board absorbed in an hour, to outside the function, which gets 
                    // updated in MongoDB
                    carbs_hr: carbs_hr,

                    // sends the value carbImpact, the expected (current) inpact in blood glucose points per minute [mg/dL/min] that occurs
                    // when the decay (absorption) happens, to outside the function, which gets updated in MongoDB
                    carbImpact: carbImpact,

                    // sends the value cob, carbs on board, the current amount of carbohydrates [grams] that are to be absorbed/decayed/eliminated 
                    // in the GI tract, to outside the function, which gets updated in MongoDB
                    cob: cob
                };
                // end of cobTotal function
            }

            //
            //
            // This function is not used
            //
            //
            function carbImpact(rawCarbImpact, insulinImpact) {
                var liverSensRatio = 1.0;
                //var liverCarbImpactMax = 1;
                //var liverCarbImpact = Math.min(liverCarbImpactMax, liverSensRatio*insulinImpact);
                var liverCarbImpact = liverSensRatio*insulinImpact;
                var netCarbImpact = Math.max(0, rawCarbImpact-liverCarbImpact);
                var totalImpact = netCarbImpact - insulinImpact;
                return {
                    netCarbImpact: netCarbImpact,
                    totalImpact: totalImpact
                }
                // end of function
            }

            // This function predicts blood glucose based on the array treatments, which includes insulin [Units] and carbohydrates [grams].
            // The prediction is also based on the array current, which includes the most current sensor glucose value [mg/dL]
            function bgPredictions(treatments, current) {
                //console.info("bgPredictions called");
               
               // Local variable tick adds 10 minutes to a for statement later on
                var tick = 10;

                // Local variable curtime is the current time and date 
                var curtime=new Date();

                // Local variable endtime is the current time and date, for now
                var endtime=new Date();

                // Local variable sgv is the current continuous glucose monitor sensor glucose value in [mg/dL]
                var sgv=parseInt(current.sgv);

                // Local variable bgi, which stands for blood glucose impact, is set equal to sgv for now
                var bgi = sgv;

                // Local variables initBG and predBgs are set to null values. Units are [mg/dL]
                var initBg = {}, predBgs = [];

                // Local object initBg.bg assigned variable sgv, which is sensor glucose value [mg/dL]
                initBg.bg = sgv;

                // Local object initBg.time assigned the variable curtime, which is the current time and date
                initBg.time = curtime;

                // adds initBg (sensor glucose value [mg/dL] and current time) to the end of predBg
                predBgs.push(initBg);

                // local variable carbsDecaying [grams], initialized to 0
                var carbsDecaying = 0;

                // endtime is set to current time + 2 [hours]
                endtime.setHours(endtime.getHours() + 2);

                // variable treatments assigned to treatments
                var treatments_r = treatments;

                // // the most recent treatment is assigned to the first index in treatments_r
                treatments_r.reverse();

                // pre loop initialization. time is assigned
                var t = new Date(curtime.getTime());


                // while t is less than endtime AND t has 10 added to it for each iteration
                for (t.setMinutes(t.getMinutes() + tick); t < endtime; t.setMinutes(t.getMinutes() + tick)) {

                    // Local variable sens, which is the insulin sensitivity factor [mg/dL/U]
                    // this is retreived from the profile information from Care Portal, stored in MongoDB
                    var sens = $scope.profile[0].sens;

                    // Local variable carbratio, which is the carb to insulin ratio [grams/Unit]
                    // this is retrieved from the profile information from Care Portal, stored in MongoDB
                    var carbratio = $scope.profile[0].carbratio;

                    // Local variable carbs_hr, which is the amount of carbohydrates absorbed in an hour [carbohydrates/hour]
                    // this is retrieved from the profile information from Care Portal, stored in MongoDB
                    var carbs_hr = $scope.profile[0].carbs_hr;

                    // Local variable carbImpact, which is the cobTotal function invoked with an object, carbImpact [mg/dL/], which is how 
                    // much blood glucose is affected by carbohydrate intake. Units are [mg/dL]
                    var carbImpact = cobTotal(treatments_r, t).carbImpact*tick;

                    // Local variable insulinImpact, which is the iobTotal function invoked with an object, activity [mg/dL/min], which is 
                    // how much blood glucose [mg/dL] is affected by insulin doses. Units are [mg/dL]
                    var insulinImpact = iobTotal(treatments, t).activity*tick;

                    // The net impact on blood glucose, due to treatments, [mg/dL] 
                    var totalImpact = carbImpact-insulinImpact;

                    // BG impact, the sensor BG [mg/dL] plus the total impact in bg [mg/dL]
                    bgi = bgi + totalImpact;

                    // setting variable time to the current time
                    var time = new Date(t.getTime());

                    // initializing variable predBg, to a null variable
                    var predBg = {};

                    // assigning predBg.bg to BG impact [mg/dL], which is the predicted BG
                    predBg.bg = bgi;

                    // assigning predBg.time to time
                    predBg.time = time;

                    // adding current predBg to the end of the array predBg
                    predBgs.push(predBg);
                }

                // max is the maximum predicted BG [mg/dL] in the array predBgs
                var max = Math.round(Math.max(predBgs));

                // min is the minimum predicted BG [mg/dL] in the array predBgs
                var min = Math.round(Math.min(predBgs));
                return {

                    // sends predBgs [mg/dL], the predicted BG values and times, outside the function and is sent to MongoDB
                    predBgs: predBgs,

                    // sends maximum predicted BG [mg/dL], outside the function and is sent to MongoDB
                    max: max,

                    // sends the minimum predicted BG [mg/dL], outside the function and is sent to MongoDB
                    min: min,

                    // sends the insulin sensitivity factor, [mg/dL/U], outside the function and is sent to MongoDB
                    sens: sens,

                    // sends the carbohydrate to insulin ratio, [grams/U], outside the function and is sent to MongoDB
                    carbratio: carbratio,

                    // sends the sensor glucose value [mg/dL], outside the function and is sent to MongoDB
                    sgv: sgv
                };

            // end of function
            }

            // This anonymous function determines the carbohydrates on board [grams] at a specified point in time. Inputs are treatment (carbohydrates [grams]), LastDecayedBy is the time when the decay or absorption of carbs ends and are eliminated from the GI tract, and time is the
            // current time. Return values include carbtime, [time], the time when the carbohydrates where initially consumed, decayedBy,
            // time in minutes when the carbohydrates are eliminated and absorbed from the GI tract. Time is the current time
            $scope.cob = function(treatment, lastDecayedBy, time) {

                // the amount of carbohydrates absorbed into the system per hour [grams/hour]
                var carbs_hr = $scope.profile[0].carbs_hr;

                // the time delay in minutes for absorption of carbohydrates
                var delay = 20;

                // the amount of carbohydrates absorbed into the system per minute [grams/minute]
                var carbs_min = carbs_hr / 60;

                // flag for determining if the carbohydrates are being absorbed
                var isDecaying = 0;        

                // the amount of initial carbohydrates to be absorbed [grams]
                var initialCarbs;


                // if treatment.carbs [grams] has a value that is not 0
                if (treatment.carbs) {

                    // the initial time when carbohydrates are consumed
                    var carbTime = new Date(treatment.created_at);

                    // declaring variable decayedBy, time
                    var decayedBy = new Date(carbTime);

                    // determining minutes left for absorption into the system
                    var minutesleft = (lastDecayedBy-carbTime)/1000/60;

                    // time in minutes when the decay or absorption of carbs ends and are eliminated from the GI tract
                    decayedBy.setMinutes(decayedBy.getMinutes() + Math.max(delay,minutesleft) + treatment.carbs/carbs_min); 
                    
                    // if delay [minutes] is greater than minutesleft [minutes]
                    if(delay > minutesleft) { 

                        // initial carbs  [grams] equals treatment.carbs
                        initialCarbs = treatment.carbs; 
                    }
                    else { 
                        // initial carbs [grams] equals treatment.carbs plus minutesleft [minutes] times carbs per minute [grams/minute]
                        initialCarbs = treatment.carbs + minutesleft*carbs_min; 
                    }

                    // initiating variable startDecay, which is the time and date of carbtime, when carbohydrates are initially consumed
                    var startDecay = new Date(carbTime);

                    // adding delay to startDecay, which is the actual time when the decay or absorption of carbohydrates occurs
                    startDecay.setMinutes(carbTime.getMinutes() + delay);

                    // if time is less than lastDecayedBy (endpoint in time for carbohydrate absorption) OR time is greater than startDecay, which
                    // is the actual time when the decay or absorption of carbohydrates occurs
                    if (time < lastDecayedBy || time > startDecay) {

                        // flag isDecaying is set to 1
                        isDecaying = 1;
                    }

                    // otherwise isDecaying is set to 0
                    else {

                        isDecaying = 0;
                    }
                    return {

                        // initial carbs [grams] equals treatment.carbs plus minutesleft [minutes] times carbs per minute [grams/minute]
                        initialCarbs: initialCarbs,

                        // time in minutes when the decay or absorption of carbs ends and are eliminated from the GI tract
                        decayedBy: decayedBy,

                        // flag for if the absorption or elimination of carbohydrates is occurring
                        isDecaying: isDecaying,

                        // time when carbohydrates are initially consumed
                        carbTime: carbTime
                    };
                }
                else {
                    // return a null value
                    return '';
                }
                // end of function
            }

            // This function calculates insulin on board [Units] for a single value of a point in time. Inputs are treatment (insulin [Units]) and 
            // time.Returns iobContrib, the amount of insulin on board at a given point [Units], and activityContrib, the amount of change in blood 
            // glucose at a given point due to insulin on board
            $scope.iob = function(treatment, time) {

                // Local variable duration of insulin action [hours], which is the how long the insulin from an initial insulin dose at a specified 
                // time lasts and has activity and impact in the system, lowering blood glucose [mg/dL]. Retrieved from the object "profile" from 
                // MongoDB, from input from Care Portal
                var dia=$scope.profile[0].dia;

                // Scaling factor, to accommodate for different durations of insulin action (length of time of insulin activity in the body after a 
                // dose--bolus--is administered in Units) that are not 3.0 hours
                var scalefactor = 3.0/dia;

                // Local variable sens, which is the insulin sensitivity factor [mg/dL/U]
                // this is retreived from the profile information from Care Portal, stored in MongoDB
                var sens=$scope.profile[0].sens;

                // declaring variables activityContrib and iobContrib
                var activityContrib, iobContrib;

                // declaring t equals time
                var t = time;


                // the time it takes for insulin to have its peak affect on blood glucose
                var peak = 75;

                // if time is not defined
                if (typeof t === 'undefined') {

                    // set t equal to current date and time
                    t = new Date();
                }

                // if treatment.insulin has a value that is not 0
                if (treatment.insulin) {

                    // set bolusTime equal to the initial time when insulin was administered [time]
                    var bolusTime=new Date(treatment.created_at);

                    // minAgo is the time elapsed from the initial time when insulin was administered [min]
                    var minAgo=(t-bolusTime)/1000/60;

                    // if minAgo is less than 0
                    if (minAgo < 0) { 
                        // insulin on board [U] and activity contribution [mg/dL/min] equal 0
                        iobContrib = 0;
                        activityContrib = 0;
                    }

                    // if minAgo is less than the duration of insulin action in minutes
                    if (minAgo < dia*60) {

                        // the normalized value of time
                        var x = (minAgo-((1/scalefactor))*90)/((1/scalefactor)*53.26);

                        // insulin on board [U] equals
                iobContrib=treatment.insulin*((-0.1663*x*x*x*x*x*x - 0.6144*x*x*x*x*x - 0.8617*x*x*x*x + 6.638*x*x*x + 6.04*x*x -42.54*x + 45.48)/100);  

                        // activity contribution [mg/dL/min] equals
                        activityContrib=sens*treatment.insulin*(2/dia/60-(minAgo-(peak*(1/scalefactor)))*2/dia/60/(60*dia-(peak*(1/scalefactor)));
                    }

                    // otherwise 
                    else {

                        // insulin on board [U] equals 0
                        iobContrib=0;

                        // activity contribution [mg/dL/min] equals 0
                        activityContrib=0;
                    }
                    return {

                        // insulin on board contribution [Units]
                        iobContrib: iobContrib,

                        // activity contribution [mg/dL/min]
                        activityContrib: activityContrib
                    };
                }
                // otherwise
                else {

                    // return a null value
                    return '';
                }
            }
            // end of function
        });

        app.service('visibility', function visibility($rootScope) {
            function visibilityChanged() {
                $rootScope.$broadcast('visibilityChanged', !!(document.hidden || document.webkitHidden || document.mozHidden || document.msHidden));
            }

            document.addEventListener('webkitvisibilitychange', visibilityChanged);
        });

    </script>

</head>
<body ng-app="ns-treatments">
<div class="container" ng-controller="TreatmentsController">
    <h3>Nightscout: IOB</h3>
    <p>Current SGV: {{bgPredictions.sgv | number: 0}} mg/dL</p>
    <p>Carbs absorbed per hour: {{cobTotal.carbs_hr | number: 0}} g</p>
    <p>Total COB: {{cobTotal.cob | number: 0}} g</p>
    <p>All carbs decayed by: {{cobTotal.decayedBy | date:'short'}}</p>
    <p>Total IOB: {{iobTotal.iob | number: 2}} U</p>
    <p>Insulin sensitivity (ISF): {{bgPredictions.sens | number: 0}} (mg/dL/U)</p>
    <p>Carb sensitivity: {{bgPredictions.sens/bgPredictions.carbratio | number: 0}} (mg/dL/g)</p>
    <p>Carb (IC) ratio: {{bgPredictions.carbratio | number: 0}} (g/U)</p>
    <p>Current Insulin Activity (BG impact): {{-iobTotal.activity | number: 2}} mg/dL/min ({{-iobTotal.activity*5 | number: 2}} mg/dL per 5 min)</p>
    <p>Current Net Carb Impact: {{carbImpact.netCarbImpact | number: 2}} mg/dL/min ({{(carbImpact.netCarbImpact)*5 | number: 2}} mg/dL per 5 min)</p>
    <p>Current Total Impact: {{carbImpact.totalImpact | number: 2}} mg/dL/min ({{(carbImpact.totalImpact)*5 | number: 2}} mg/dL per 5 min)</p>
    <p>Total Carbs Absorbed in last 8h: {{eightHourCarbs.lookbackCarbs - cobTotal.cob | number: 0}} g</p>
    <p>Total Carbs Eaten in last 3h: {{threeHourCarbs.lookbackCarbs | number: 0}} g</p>
    <p>Total Insulin in last 3h: {{threeHourInsulin.lookbackInsulin | number: 1}} U</p>
    <p>BG Predictions:</p>
    <ul>
        <li ng-repeat="pred in bgPredictions.predBgs">
            {{ pred.time | date:'short'}}, {{pred.bg | number: 0}}
        </li>
    </ul>
    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <td>Time</td>
            <td>BG (mg/dL)</td>
            <td>Insulin (U)</td>
            <td>Carbs (g)</td>
            <td>IOB (U)</td>
            <td>Insulin Act. (mg/dL/min)</td>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="treatment in treatments">
            <td>{{treatment.created_at | date:'short'}}</td>
            <td>{{glucoseDisplay(treatment)}}</td>
            <td>{{treatment.insulin | number: 2}}</td>
            <td>{{treatment.carbs}}</td>
            <td>{{iob(treatment).iobContrib | number: 2}}</td>
            <td>{{iob(treatment).activityContrib | number: 2}}</td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>