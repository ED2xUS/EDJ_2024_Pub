<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bolus Calc Advanced</title>
    <link rel="shortcut icon" href="https://beetusbot.herokuapp.com/images/favicon.ico">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 
    <style>
      body {padding: 30px 30px 30px 30px;}
      input[type=submit] {width: 49%; margin-top: 5px; }
      input[type=button] {width: 49%; margin-top: 5px; }
      input[type=number] {width: 49%; margin-top: 5px; }
      div {width:100%; max-width: 350px;}
      form {width:100%; max-width: 350px;}
	    select { width: 30%; margin-top: 5px; }
      div.alt1{background-color: #d7f1f4; margin-bottom: 5px; padding: 8px;}
      div.alt2{background-color: #c0e9ed; margin-bottom: 5px; padding: 8px;}
	    .leftcolumn { width: 50%; padding-right: 1%; display: table-cell; }
	    .leftcolumn input[type=button] {width: 100%; }
	    .leftcolumn input[type=submit] {width: 100%; }
	    .rightcolumn { width: 50%; padding-left: 1%; display: table-cell; }
	    .rightcolumn input[type=button] {width: 100%; }
	    .rightcolumn input[type=submit] {width: 100%; }
	    .columnwrap { width: 100%; display: table; }
	    #results_mealdose { display: none; }    
    </style>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!--<script src="https://beetusbot.herokuapp.com/js/bootstrap.min.js"></script>-->
    <script type="text/javascript" src="https://beetusbot.herokuapp.com/js/jquery.ajax-cross-origin.min.js"></script>
    
    <script type="text/javascript">
      $(document).ready(function(){
      
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ INSTANTIATE VARIABLES ~~~~~~~~~~~~~~~~~~~~~~~~~
      
	//Static
	var BGgoal = 90;
	var hostname = location.protocol + '//' + location.host;
	var MFPurl = "http://www.myfitnesspal.com/food/diary/oboe_girl4";
	var profileURL = hostname+"/api/v1/profile.json";
	var entriesURL = hostname+"/api/v1/entries.json";
	var treatmentsURL = hostname+"/api/v1/treatments.json";
	var secret = "c96c4972f2f35a0b74e91b75dccf0d3807a16ad1";
		
	//Dynamic
	var today;
        var hours = 0;
        var minutes = 0;
        var timeStr = '';
	var UTCtimeStr = '';
		
      var currBG = 0;
      var delta30mins = 0;
      var delta60mins = 0;
      var BGtrend = "";
      var currProfile = "";
      var currBasal = 0.0;
      var currSens = 0.0;
      var currCarbRatio = 0.0;	
		
      var mfpCode = '';
      var mealCode = '';  
      var carbs = 0;
      var fat = 0;
      var protein = 0;
      var fiber = 0;
      var eventType = '';
	var basalnotes = '';
	var netCarbs = 0;
		
	var newBolus = 0;
      var newBolusExt = 0;
      var newBolusCorr = 0;
      var newBolusSuper = 0;
      var newBolusCarbs = 0;
      var newBolusProtein = 0;
	var newBolusFat = 0;
      var additionalMessage = '';
      var addCarbs = 0;
      var trendChar = '';
      var trendText = '';
      var totalBolus = 0;
      var percentNow = 0;
      var percentExt = 0;
      var prebolus = 0;
		
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ DEFINE FUNCTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~
	function getDate(){
		today = new Date(); // for now
	      hours = today.getHours(); 
	      if (hours < 10) { hours = "0"+hours; }
	      minutes = today.getMinutes(); 
	      if (minutes < 10) { minutes = "0"+minutes; }
	      timeStr = hours+":"+minutes;
		UTCtimeStr = today.toJSON();

	}
		
	function resetVars(){
		getDate();

		getCustomJSON(profileURL,"profile",function(returndata){
	      });

	      getCustomJSON(entriesURL+"?count=12","BG",function(returndata){      
		BGtrends();
	      });

		mfpCode = '';
	      mealCode = '';  
	      resetMealData();

	      eventType = '';
		basalnotes = '';

		newBolus = 0;
		newBolusExt = 0;
		newBolusCorr = 0;
		newBolusSuper = 0;
		newBolusCarbs = 0;
		newBolusProtein = 0;
		newBolusFat = 0;
		additionalMessage = '';
		addCarbs = 0;
		totalBolus = 0;
		percentNow = 0;
		percentExt = 0;
		prebolus = 0;
		
		document.getElementById("basalduration").value = "";
		document.getElementById("basalpercent").value = "";

		document.getElementById("submission_meal").innerHTML = "";
		document.getElementById("results_meal").innerHTML = "";
		$("#results_mealdose").hide();
		document.getElementById("submission_correction").innerHTML = "";
		document.getElementById("results_correction").innerHTML = "";
		document.getElementById("submission_carbsonly").innerHTML = "";
		document.getElementById("results_carbs").innerHTML = "";
		document.getElementById("submission_tempbasal").innerHTML = "";
		document.getElementById("submission_exercise").innerHTML = "";
		document.getElementById("submission_removepump").innerHTML = "";
		
	}    
	      
      function cleardivs(exception){

		document.getElementById("submission_meal").innerHTML = "";
	        if(exception != "Meal") { document.getElementById("results_meal").innerHTML = ""; 
					$("#results_mealdose").hide();}
		document.getElementById("submission_correction").innerHTML = "";
		if(exception != "Correction") { document.getElementById("results_correction").innerHTML = ""; }
		document.getElementById("submission_carbsonly").innerHTML = "";
	        if(exception != "Carbs") { document.getElementById("results_carbs").innerHTML = ""; }
		document.getElementById("submission_tempbasal").innerHTML = "";
		document.getElementById("submission_exercise").innerHTML = "";
		document.getElementById("submission_removepump").innerHTML = "";
		
	}
      
      function getCustomJSON(URL, type, callback){
        $.ajax({
            url: URL,
            method: 'GET',
            dataType: 'json',
            //crossOrigin: true,
            success: function(inputData){
              var data = inputData; //jQuery.parseJSON(inputData);
            	if(type == "profile") {
                 currProfile = data[0].defaultProfile;

                 // Define current basal 
                 var basalProfile = data[0].store[currProfile].basal;  
                 if(timeStr > basalProfile[Object.keys(basalProfile).length-1].time){
                     currBasal = parseFloat(basalProfile[Object.keys(basalProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(basalProfile).length; i++){
                     //console.log("Basal profile time/value "+i+ ": "+basalProfile[i].time+ " / "+basalProfile[i].value);
                     if (timeStr < basalProfile[i].time) {
                       currBasal = parseFloat(basalProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current sensitivity
                 var sensProfile = data[0].store[currProfile].sens;  
                 if(timeStr > sensProfile[Object.keys(sensProfile).length-1].time){
                     currSens = parseFloat(sensProfile[Object.keys(sensProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(sensProfile).length; i++){
                     if (timeStr < sensProfile[i].time) {
                       currSens = parseFloat(sensProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current carb ratio
                 var ratioProfile = data[0].store[currProfile].carbratio;  
                 if(timeStr > ratioProfile[Object.keys(ratioProfile).length-1].time){
                     currCarbRatio = parseFloat(ratioProfile[Object.keys(ratioProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(ratioProfile).length; i++){
                     if (timeStr < ratioProfile[i].time) {
                       currCarbRatio = parseFloat(ratioProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Return values
                 callback(currProfile,currBasal,currSens,currCarbRatio);
               }
               if(type == "BG") {
                 // Define current BG
                 currBG = parseInt(data[0].sgv);
                 delta30mins = parseInt(data[0].sgv)-parseInt(data[5].sgv);
                 delta60mins = parseInt(data[0].sgv)-parseInt(data[11].sgv);
                 BGtrend = data[0].direction;
                 callback(currBG,delta30mins,delta60mins,BGtrend);
               }
               
            },
            error: function(data){
            	document.getElementById("errors").innerHTML = "Derp derp derp.";
            }
            });    
      }
      
      function getMFPData(callback){
      	$.ajax({
            url: MFPurl,
            method: 'GET',
            dataType: 'html',
            crossOrigin: true,
            success: function(data){
               mfpCode = data;
               callback(mfpCode);
            },
            error: function(data){
               document.getElementById("errors").innerHTML += "MyFitnessPal data could not be pulled";
            }
         }); 
      }
        
      function getMealData(mealName){
        getMFPData(function(returnData){
		var breakfastStart = mfpCode.indexOf('<tr class="meal_header">');
		var lunchStart = mfpCode.indexOf('<tr class="meal_header">',breakfastStart+24); 
		var dinnerStart = mfpCode.indexOf('<tr class="meal_header">',lunchStart+24); 
		var aftSnackStart = mfpCode.indexOf('<tr class="meal_header">',dinnerStart+24); 
		var mornSnackStart = mfpCode.indexOf('<tr class="meal_header">',aftSnackStart+24); 
		var eveSnackStart = mfpCode.indexOf('<tr class="meal_header">',mornSnackStart+24); 
		var end = mfpCode.indexOf('<tr class="spacer">',eveSnackStart+24);
		if(mealName == "Breakfast"){ mealCode = mfpCode.substring(breakfastStart,lunchStart); }
		else if(mealName == "Lunch"){ mealCode = mfpCode.substring(lunchStart,dinnerStart); }
		else if(mealName == "Dinner"){ mealCode = mfpCode.substring(dinnerStart,aftSnackStart); }
		else if(mealName == "Afternoon Snack"){ mealCode = mfpCode.substring(aftSnackStart,mornSnackStart); }
		else if(mealName == "Morning Snack"){ mealCode = mfpCode.substring(mornSnackStart,eveSnackStart); }
		else if(mealName == "Evening Snack"){ mealCode = mfpCode.substring(eveSnackStart,end); }
		var totalsRef = mealCode.indexOf('class="quick_add_meals_list hidden">');
		// Carbs
		var carbsStart = mealCode.indexOf('<span class="macro-value">',totalsRef)+26;
		//console.log("Carbs starting index: "+carbsStart);
		var carbsEnd = mealCode.indexOf('</span>',carbsStart);
		//console.log("Carbs ending index: "+carbsEnd);
		carbs = parseFloat(mealCode.substring(carbsStart,carbsEnd));
		// Fat
		var fatStart = mealCode.indexOf('<span class="macro-value">',carbsEnd)+26;
		var fatEnd = mealCode.indexOf('</span>',fatStart);
		fat = parseFloat(mealCode.substring(fatStart,fatEnd)); 
		// Protein
		var proteinStart = mealCode.indexOf('<span class="macro-value">',fatEnd)+26;
		var proteinEnd = mealCode.indexOf('</span>',proteinStart);
		protein = parseFloat(mealCode.substring(proteinStart,proteinEnd));
		// Fiber
		var fiberStart = mealCode.indexOf('<td>',proteinEnd)+4;
		var fiberEnd = mealCode.indexOf('</td>',fiberStart);
		fiber = parseFloat(mealCode.substring(fiberStart,fiberEnd));
		if(isNaN(carbs) || isNaN(carbs) || isNaN(carbs) || isNaN(carbs)){
			document.getElementById("results_meal").innerHTML = "<br/>No meal data available."; 
		}
		else{
			document.getElementById("carbs").value = carbs; 
			document.getElementById("fat").value = fat; 
			document.getElementById("protein").value = protein;  
			document.getElementById("fiber").value = fiber; 
			bolusCalcWFood(mealName);
		}	
        }); 
      }	
		
	function resetMealData(){
		carbs = 0;
		fat = 0;
		protein = 0;
		fiber = 0;
		netCarbs = 0;
		document.getElementById("carbs").value = 0;
		document.getElementById("fat").value = 0;  
		document.getElementById("protein").value = 0;  
		document.getElementById("fiber").value = 0;
		//document.getElementById("prebolus").value = 0;
	}
      
      function bolusCalcWFood(mealName){
      	newBolus = 0;
      	newBolusExt = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	newBolusCarbs = 0;
      	newBolusProtein = 0;
	newBolusFat = 0;
      	additionalMessage = '';
        addCarbs = 0;
        totalBolus = 0;
        percentNow = 0;
        percentExt = 0;
	netCarbs = 0;
	
        if(mealName == "Breakfast"){ 
		netCarbs = carbs - (fiber / 2); 
	}
	else{
		netCarbs = carbs-fiber;
	}
	newBolusCorr = (currBG-BGgoal)/currSens; //Correction
	newBolusCarbs = netCarbs/currCarbRatio; //Carbs
	      
        if(currBG>160){  
          newBolusSuper = currBasal; //Super bolus
          additionalMessage = "Super bolus, wait till bend.";
          if((netCarbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
            additionalMessage = "Super bolus, wait till bend if possible.";
          }
        }
        else if(currBG>110){
          if((netCarbs>30) || (fat<20)){
		if((prebolus <= 10) && (fat<20)){ 
			newBolusSuper = currBasal; 
			additionalMessage = "Super bolus, wait till bend if possible.";		       
		} //Super bolus 
		else{
			additionalMessage = "Wait till bend if possible.";
		}
          	if(prebolus>10){
			additionalMessage = "Wait till bend if possible.";
		}
          }
          else{
		  if(prebolus <= 5){ newBolusSuper = currBasal; } //Super bolus 
          	additionalMessage = "Super bolus if eating immediately.";
          }
          if((netCarbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else if(currBG>70){
          if(netCarbs>30){
          	if(prebolus <= 5){ newBolusSuper = currBasal; } //Super bolus 
            	additionalMessage = "Super bolus if eating immediately.";
          }
          if((netCarbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else{
          if((netCarbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
	if(fat>20){
            //newBolusFat = (((fat-20)/2)/currCarbRatio); //Fat
	      newBolusFat = newBolusCarbs*.2;
	      newBolusCarbs = newBolusCarbs*.8;
          }
        newBolus = newBolusCorr+newBolusSuper+newBolusCarbs;
	newBolusExt = newBolusFat + newBolusProtein;
        totalBolus = newBolus + newBolusExt;
        percentNow = (newBolus/totalBolus)*100;
        percentExt = (newBolusExt/totalBolus)*100;
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
          	document.getElementById("results_meal").innerHTML = "<br/>Need more carbs! Eat "+addCarbs.toFixed(0)+"g. &#x1F36C";
        }
        else{
	  var extBolusText = '';
	  if(newBolusExt > 0){
		  extBolusText = " ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+newBolus.toFixed(2)+" + "+newBolusExt.toFixed(2)+" extended over 2 hours. ";
	  }
	  else{ extBolusText = ". "; }	

          	document.getElementById("results_meal").innerHTML = "<br/>Recommended bolus: "
			+ totalBolus.toFixed(2)+ extBolusText + additionalMessage;
		$("#results_mealdose").show();
		document.getElementById("carbdose_meal").value = newBolusCarbs.toFixed(2);
		document.getElementById("extdose_meal").value = newBolusExt.toFixed(2);
		document.getElementById("corrdose_meal").value = newBolusCorr.toFixed(2);
		document.getElementById("super_meal").value = newBolusSuper.toFixed(2);
			
        }
      }
      
      function bolusCalc(){
      	newBolus = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	additionalMessage = '';
        addCarbs = 0;
        if(currBG>160){
          newBolusCorr = (currBG-BGgoal)/currSens;
          newBolusSuper = currBasal; //Correction + Super bolus
          additionalMessage = "Add super bolus."
        }
        else if(currBG>110){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
        }
        else if(currBG>70){
          newBolusCorr = 0;
        }
        else{
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction UP
        }
        newBolus = newBolusCorr + newBolusSuper;
	var divToWriteTo = '';
	if(eventType == "Carb Correction") { divToWriteTo = 'results_carbs'; }
	if(eventType == "Correction Bolus") { divToWriteTo = 'results_correction'; }      
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
		document.getElementById(divToWriteTo).innerHTML = "<br/>Need more carbs! Eat "+addCarbs.toFixed(0)+"g. &#x1F36C";
		document.getElementById("corrCarbs").value = addCarbs.toFixed(0); 	
        }
        else if (newBolus==0){
          document.getElementById(divToWriteTo).innerHTML = "<br/>No carbs needed!";
        }
        else{ 
	  if(eventType == "Carb Correction") { document.getElementById(divToWriteTo).innerHTML = "<br/>No carbs needed!"; }
	  if(eventType == "Correction Bolus") { 
		document.getElementById(divToWriteTo).innerHTML = "<br/>Recommended bolus: "+newBolus.toFixed(2)+". "+ additionalMessage +"<br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2);
	  	document.getElementById("corrdose").value = newBolus; 
	  }   	 
        }
      }
      
      function BGtrends(){
      	trendChar = '';
        trendText = '';
	var origBG = currBG;
      	if(BGtrend == "FortyFiveUp") { currBG += 15; trendChar='&#x2197';}
        if(BGtrend == "SingleUp") { currBG += 30; trendChar='&#x2B06';}
        if(BGtrend == "DoubleUp") { currBG += 50; trendChar='&#x23EB';}
        if(BGtrend == "FortyFiveDown") { currBG -= 15; trendChar='&#x2198';}
        if(BGtrend == "SingleDown") { currBG -= 30; trendChar='&#x2B07';}
        if(BGtrend == "DoubleDown") { currBG -= 50; trendChar='&#x23EC';}
        if(BGtrend == "Flat") {trendChar='&#x27A1';}
	var trendWarn = '';
	if((delta60mins >= 30) || (delta60mins <= -30)){ trendWarn = " &#x2757"; }
        trendText = "BG: "+origBG+"<br/>BG Trend: "+trendChar+"<br/>30 min delta: "+delta30mins+"<br/>60 min delta: "+delta60mins+trendWarn;
        document.getElementById("resultsBG").innerHTML = trendText;
      }
		
	function setTemp(type){
		if(type == "Engine Braking"){
			document.getElementById("basalduration").value = 30; 
			document.getElementById("basalpercent").value = -100; 	
			basalnotes = "Engine Braking";
		}
		if(type == "Super Bolus"){
			document.getElementById("basalduration").value = 60; 
			document.getElementById("basalpercent").value = -100; 
			basalnotes = "Super Bolus";
		}
	}
	
	function randomIntFromInterval(min,max){
          return Math.floor(Math.random()*(max-min+1)+min);
      }
		
	function runTest(){
		carbs = randomIntFromInterval(0,100);
		fat = randomIntFromInterval(0,40);
		protein = randomIntFromInterval(0,60);
		fiber = randomIntFromInterval(0,30);
		currBG = randomIntFromInterval(40,300);
		document.getElementById("carbs").value = carbs; 
		document.getElementById("fat").value = fat; 
		document.getElementById("protein").value = protein; 
		document.getElementById("fiber").value = fiber; 
		document.getElementById("BG").value = currBG; 
		bolusCalcWFood("Test");
      }

	function sendExercise(event,type){
	  eventType = "Exercise"; 
	  event.preventDefault();
	  var exercisetime = document.getElementById("exerciseduration").value;
	  var exerciseSuggestion = '';
	  if(type == "Dance"){
		 exerciseSuggestion = "Expect a BG drop of "+ exercisetime + " to be adjusted by " + (exercisetime/currSens).toFixed(2) + " less insulin or " + (exercisetime/(currSens/currCarbRatio)).toFixed(0) + " carbs. Set a 12 hour post-exercise temp basal of -20%."
	  }
	  if(type == "Yoga"){
		 exerciseSuggestion = "30 mins prior to end of session, if BGs have not been dropping, do 2 units to cover post exercise high. Set a 12 hour post-exercise temp basal of -10%."
	  }
	  if(type == "Other"){
		  exerciseSuggestion = "If aerobic, expect a BG drop of "+ exercisetime + " to be adjusted by " + (exercisetime/currSens).toFixed(2) + " less insulin or " + (exercisetime/(currSens/currCarbRatio)).toFixed(0) + " carbs. Set a 12 hour post-exercise temp basal of -20%.<br/><br/>If anaerobic, 30 mins prior to end of session, if BGs have not been dropping, do 2 units to cover post exercise high. Set a 12 hour post-exercise temp basal of -10%."
	  }
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":exercisetime,"notes":type,"eventType":eventType,"secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_exercise").innerHTML = "Data submitted &#x1F44D "+exerciseSuggestion;
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_exercise").innerHTML = "Data NOT submitted &#x1F44E "+exerciseSuggestion;  
	  });
	}
			
		
	function postData(input, callback){
			var posting = $.post( treatmentsURL, input );
			  posting.done(function( data ) {
			    callback(data);
			  }); 
			  posting.fail(function( data) {
			    callback(data);
			  });
	}
	      
	function calcFoodBolus(mealOrSnack, name){
	      resetVars(); 
	      eventType = mealOrSnack+" Bolus"; 
	      prebolus = document.getElementById("prebolus").value;
	      getMealData(name);
      }
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ RUN FUNCTIONS ON PAGE LOAD ~~~~~~~~~~~~~~~~~~~~~~~~~
		
	getDate();
		
	getCustomJSON(profileURL,"profile",function(returndata){
        /*document.getElementById("basal").value = currBasal;
        document.getElementById("sensitivity").value = currSens;
        document.getElementById("carbRatio").value = currCarbRatio; */
      });
        
      getCustomJSON(entriesURL+"?count=12","BG",function(returndata){      
        //document.getElementById("BG").value = currBG; 
        BGtrends();
      });
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ SET BUTTON ACTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~	
		
      $("#BreakfastButton").click(function() { calcFoodBolus("Meal", "Breakfast"); });
      $("#LunchButton").click(function() { calcFoodBolus("Meal", "Lunch");  });
      $("#DinnerButton").click(function() { calcFoodBolus("Meal", "Dinner");  });
      $("#MornSnackButton").click(function() { calcFoodBolus("Snack", "Morning Snack"); });
      $("#AftSnackButton").click(function() { calcFoodBolus("Snack", "Afternoon Snack"); });
      $("#EveSnackButton").click(function() { calcFoodBolus("Snack", "Evening Snack"); });
      $("#suggest_meal").click(function() { 
	        prebolus = document.getElementById("prebolus").value;
		carbs = document.getElementById("carbs").value;
		fat = document.getElementById("fat").value;  
		protein = document.getElementById("protein").value;  
		fiber = document.getElementById("fiber").value;
	        eventType = "Meal Bolus";
	      	bolusCalcWFood("N/A");
      });      
      $("#CorrOnly").click(function() { resetVars(); eventType = "Correction Bolus"; bolusCalc(); });
      $("#CarbsOnly").click(function() { resetVars(); eventType = "Carb Correction"; bolusCalc(); });
      $("#EngineBraking").click(function() { resetVars(); eventType = "Temp Basal"; setTemp("Engine Braking"); });
      $("#SuperBolus").click(function() { resetVars(); eventType = "Temp Basal"; setTemp("Super Bolus"); });
      //$("#TestButton").click(function() { eventType = "Meal Bolus"; runTest(); });
      $("#Dance").click(function(event) { 
	      resetVars();
	      sendExercise(event,"Dance");
      });
      $("#Yoga").click(function(event) { 
	      resetVars();
	     sendExercise(event,"Yoga"); 
      });
      $("#Other").click(function(event) { 
	      resetVars();
	      sendExercise(event,"Other");
      });	
      $("#mealform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("Meal");
	  var $form = $( this ),
	  prebolus = $form.find( "select[id='prebolus']" ).val(),
	  finalcarbdose = $form.find( "input[id='carbdose_meal']" ).val(),
	      finalextdose = $form.find( "input[id='extdose_meal']" ).val(),
	      finalcorrdose = $form.find( "input[id='corrdose_meal']" ).val(),
	      finalsuperdose = $form.find( "input[id='super_meal']" ).val();  
	  var finalNonCorrNonExtDose = finalcarbdose+finalsuperdose;
	  if(finalextdose > 0){ 
		  //Get time
		today = new Date(); // for now
		//Divide time
		var newDate = new Date(today);
		var insulinDiv = finalextdose/12.0;
		var t;
		var UTCMonth;
		for (t = 0; t < 12; t++){
			newDate.setTime(newDate.getTime() + 10*60*1000);
			//Format new time
			UTCtimeStr = newDate.toJSON();
			//Send fractional insulin amounts to NS
			postData({ "enteredBy":"BolusCalc","insulin":insulinDiv,"created_at":UTCtimeStr,"secret":secret },function(data){
			});	
		}
			     
	}
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":netCarbs,"insulin":finalNonCorrNonExtDose,"eventType":eventType,"preBolus":prebolus,"secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_meal").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_meal").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":finalcorrdose,"eventType":"Correction Bolus","secret":secret } );
          posting2.done(function( data ) {
            document.getElementById("submission_meal").innerHTML += " plus correction bolus";
          }); 
	  posting2.fail(function( data) {
	    document.getElementById("submission_meal").innerHTML += " WITHOUT correction bolus";  
	  });
	      if(finalsuperdose>0){
		  var posting3 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":"Temp Basal","notes":"Super bolus","secret":secret } );
		  // Put the results in a div
		  posting3.done(function( data ) {
		    document.getElementById("submission_meal").innerHTML += " plus super bolus temp basal.";
		  }); 
		  posting3.fail(function( data) {
		    document.getElementById("submission_meal").innerHTML += " WITHOUT super bolus temp basal.";  
		  });
	  }
	  var newTotal = 0;
	  if((finalcarbdose != newBolusCarbs) || (finalextdose != newBolusExt) || (finalcorrdose != newBolusCorr) || (finalsuperdose != newBolusSuper)){
		  newTotal = finalcarbdose+finalextdose+finalcorrdose+finalsuperdose;
		  percentNow = ((finalcarbdose+finalcorrdose+finalsuperdose)/newTotal)*100;
		  percentExt = (finalextdose/newTotal)*100;
		  document.getElementById("submission_meal").innerHTML += "<br/><br/>New total: "+newTotal.toFixed(2)+" ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+(finalcarbdose+finalcorrdose+finalsuperdose).toFixed(2)+" + "+finalextdose.toFixed(2)+" extended over 2 hours. "
	  } 
        });
	$("#correctionform").submit(function( event ) {
          // Stop form from submitting normally
          event.preventDefault();
	  cleardivs("Correction");
          // Get some values from elements on the page
	  var $form = $( this ),
	    corrdose = $form.find( "input[id='corrdose']" ).val();
          // Send the data using post 
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":corrdose,"eventType":"Correction Bolus","secret":secret } );
          // Put the results in a div
          posting.done(function( data ) {
            document.getElementById("submission_correction").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_correction").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	  if(corrdose == newBolusCorr){     
		  if(newBolusSuper>0){
			  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":"Temp Basal","notes":basalnotes,"secret":secret } );
			  // Put the results in a div
			  posting2.done(function( data ) {
			    document.getElementById("submission_correction").innerHTML += " plus super bolus temp basal.";
			  }); 
			  posting2.fail(function( data) {
			    document.getElementById("submission_correction").innerHTML += " WITHOUT super bolus temp basal.";  
			  });
		  }
	  }
        });
	      
	$("#carbsonlyform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("Carbs");
	  var $form = $( this ),
	    corrCarbs = $form.find( "input[id='corrCarbs']" ).val();
	  eventType = "Carb Correction";
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":corrCarbs,"eventType":eventType,"notes":"Low","secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_carbsonly").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_carbsonly").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
	      
	$("#tempbasalform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("N/A");
	  var $form = $( this ),
	    basald = $form.find( "input[id='basalduration']" ).val(),
	    basalp = $form.find( "input[id='basalpercent']" ).val();
	  if(eventType == '') { eventType = "Temp Basal"; }
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":basald,"percent":basalp,"eventType":eventType,"notes":basalnotes,"secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_tempbasal").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_tempbasal").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
	      
	$("#removepumpform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("N/A");
	  var $form = $( this ),
	    pumpoffduration = $form.find( "input[id='pumpoffduration']" ).val();
	  var insulinreco = (pumpoffduration/60)*currBasal;
	  var addToReco = '';
	  if(currBG >= BGgoal){
		  var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":insulinreco,"notes":"Shower","secret":secret } );
		  posting.done(function( data ) {
		    document.getElementById("submission_removepump").innerHTML = "Data submitted &#x1F44D Bolus "+insulinreco+" units before removing. ";
		  }); 
		  posting.fail(function( data) {
		    document.getElementById("submission_removepump").innerHTML = "Data NOT submitted &#x1F44E Bolus "+insulinreco+" units before removing. ";  
		  });
	  }
	  else{
		  addToReco = " No bolus required.";
	  }
	  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","eventType":"Temp Basal","duration":pumpoffduration,"notes":"Shower","secret":secret } );
          posting2.done(function( data ) {
            document.getElementById("submission_removepump").innerHTML += "Temp basal set."+addToReco;
          }); 
	  posting2.fail(function( data) {
	    document.getElementById("submission_removepump").innerHTML += "Temp basal NOT set."+addToReco;  
	  });
        });
      
      });
      
    </script>
    
  </head>
  <body>

    <div id="statusdiv" class="alt1">  
    <b>Current Stats</b><br/>	  
    <div id="resultsBG"></div>
	  </div>
	  
    <div id="mealdiv" class="alt2">
    <b>Meal or Snack</b><br/>
    <form id="mealform">	    
      Load meal:<br/>
	    <select id="prebolus">
	  <option value="0" selected="selected">0</option>
	  <option value="5">5</option>
		<option value="10">10</option>
		<option value="15">15</option>
		<option value="20">20</option>
		<option value="25">25</option>
		<option value="30">30</option>
	</select> Carb time<br/>
	    <div class="columnwrap">
	    <div class="leftcolumn">
		    <input id="BreakfastButton" type="button" value="Breakfast" /><br/>
		    <input id="LunchButton" type="button" value="Lunch" /><br/>
		    <input id="DinnerButton" type="button" value="Dinner" />
	    </div>
	    <div class="rightcolumn">
		   <input id="MornSnackButton" type="button" value="Morning Snack" /><br/>
		    <input id="AftSnackButton" type="button" value="Afternoon Snack" /><br/>
		    <input id="EveSnackButton" type="button" value="Evening Snack" />
	    </div>
	    </div>
	    <br/>    
      Results:<br/>
      <input type="number" step="0.1" id="carbs" placeholder="Grams" min="0" value="0" /> Carbs<br/>
      <input type="number" step="0.1" id="fat" placeholder="Grams" min="0" value="0" /> Fat<br/>
      <input type="number" step="0.1" id="protein" placeholder="Grams" min="0" value="0" /> Protein<br/>
      <input type="number" step="0.1" id="fiber" placeholder="Grams" min="0" value="0" /> Fiber<br/><br/>
	
      <!--<input type="button" id="TestButton" value="Process Test Data" /><br/><br/>-->
	<input type="button" id="suggest_meal" value="Manual entry" /><br/>
	    <div id="results_meal"></div>
	    <div id="results_mealdose">
		<input type="number" step="0.01" id="carbdose_meal" min="0" value="0"/> Carbs
		<br/><input type="number" step="0.01" id="extdose_meal" min="0" value="0"/> Extended
		<br/><input type="number" step="0.01" id="corrdose_meal" min="0" value="0"/> Correction
		<br/><input type="number" step="0.01" id="super_meal" min="0" value="0"/> Super 
	    </div>
      <input type="submit" id="submit_meal" value="Submit meal/snack" /><br/>
    </form>
    <div id="submission_meal"></div>
    
	  </div>

    <div id="correctiondiv" class="alt1">	  
    <b>Correction Only</b><br/>	  
    <form id="correctionform">
	    <input type="number" id="corrdose" step="0.01" min="0" /> Units<br/>
	    <input type="button" id="CorrOnly" value="Suggest correction" /><br/>
	    <input type="submit" id="submit_correction" value="Submit correction" />
	  </form>
	  <div id="submission_correction"></div>
    <div id="results_correction"></div>
	  </div>
	  
	  <div id="carbsdiv" class="alt2">
<b>Carbs Only</b><br/>	
	<form id="carbsonlyform">
	<input type="number" step="0.1" id="corrCarbs" placeholder="Carbs in grams" min="0" value="8"/> Carbs<br/>
	<input type="button" id="CarbsOnly" value="Suggest carbs" /><br/>
	<input type="submit" id="submit_carbs" value="Submit carbs" /><br/>
	  </form>
	  <div id="submission_carbsonly"></div>
	  <div id="results_carbs"></div>
	  </div>
	  
	  <div id="tempbasaldiv" class="alt1">
	  <b>Temp Basal</b><br/>
	<form id="tempbasalform">
	<input type="number" id="basalduration" placeholder="Minutes" min="0" /> Duration<br/>
      	<input type="number" id="basalpercent" placeholder="Basal change in %" min="-100" /> % Change<br/>
		<div class="columnwrap">
		<div class="leftcolumn">
		<input type="button" id="EngineBraking" value="Engine braking" /><br/>
		<input type="submit" id="submit_tempbasal" value="Submit" />
		</div>
		<div class="rightcolumn">
		<input type="button" id="SuperBolus" value="Super bolus" />
		</div>
		</div>
	  </form>
	  <div id="submission_tempbasal"></div>
	  </div>
	  
	  <div id="exercisediv" class="alt2">
	  <b>Exercise</b><br/>	
	<form id="exerciseform">
	<input type="number" id="exerciseduration" placeholder="Minutes" min="0" /> Duration<br/>
		<div class="columnwrap">
		<div class="leftcolumn">
		<input type="button" id="Dance" value="Dance" /><br/>
		<input type="button" id="Other" value="Other" />
		</div>
		<div class="rightcolumn">
			<input type="button" id="Yoga" value="Yoga" />
		</div>
		</div>
	
	  </form>
	  <div id="submission_exercise"></div>
	  </div>
	  
	  <div id="removepumpdiv" class="alt1">
	   <b>Remove Pump</b><br/>	
	<form id="removepumpform">
	<input type="number" id="pumpoffduration" placeholder="Minutes" min="0" /> Duration<br/>
	<input type="submit" id="RemovePump" value="Submit" />
	  </form>
	  <div id="submission_removepump"></div>
	  </div>
	  
	  <div id="errors"></div>

  </body>
</html>
