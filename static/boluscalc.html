<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Bolus Calc Advanced</title>
    
    <link rel="shortcut icon" href="https://beetusbot.herokuapp.com/images/favicon.ico">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 

    <style>
      body {padding: 30px 30px 30px 30px;}
      input[type=submit] {width: 50%;}
      input[type=button] {width: 50%;}
      input[type=number] {width: 50%;}
      input[type=text] {width: 100%;}
      div {max-width: 300px;}
      form {max-width: 300px;}
    </style>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!--<script src="https://beetusbot.herokuapp.com/js/bootstrap.min.js"></script>-->
    <script type="text/javascript" src="https://beetusbot.herokuapp.com/js/jquery.ajax-cross-origin.min.js"></script>
    
    <script type="text/javascript">
        
      $(document).ready(function(){
	(function() { // Begin scoping function
        
      var today = new Date(); // for now
      var hours = today.getHours(); 
      if (hours < 10) { hours = "0"+hours; }
      var minutes = today.getMinutes(); 
      if (minutes < 10) { minutes = "0"+minutes; }
      var timeStr = hours+":"+minutes;
      
      var currBG = 0;
      var delta30mins = 0;
      var delta60mins = 0;
      var BGtrend = "";
      var currProfile = "";
      var currBasal = 0.0;
      var currSens = 0.0;
      var currCarbRatio = 0.0;
      
      function getCustomJSON(URL, type, callback){
        $.ajax({
            url: URL,
            method: 'GET',
            dataType: 'json',
            //crossOrigin: true,
            success: function(inputData){
              var data = inputData; //jQuery.parseJSON(inputData);
            	if(type == "profile") {
                 currProfile = data[0].defaultProfile;
                 //console.log("Type of data: " + typeof (data[0].store[currProfile].basal[1].time));
                 //console.log("Length of object: " + Object.keys(basalProfile).length);

                 // Define current basal 
                 var basalProfile = data[0].store[currProfile].basal;  
                 if(timeStr > basalProfile[Object.keys(basalProfile).length-1].time){
                     currBasal = parseFloat(basalProfile[Object.keys(basalProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(basalProfile).length; i++){
                     //console.log("Basal profile time/value "+i+ ": "+basalProfile[i].time+ " / "+basalProfile[i].value);
                     if (timeStr < basalProfile[i].time) {
                       currBasal = parseFloat(basalProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current sensitivity
                 var sensProfile = data[0].store[currProfile].sens;  
                 if(timeStr > sensProfile[Object.keys(sensProfile).length-1].time){
                     currSens = parseFloat(sensProfile[Object.keys(sensProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(sensProfile).length; i++){
                     if (timeStr < sensProfile[i].time) {
                       currSens = parseFloat(sensProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current carb ratio
                 var ratioProfile = data[0].store[currProfile].carbratio;  
                 if(timeStr > ratioProfile[Object.keys(ratioProfile).length-1].time){
                     currCarbRatio = parseFloat(ratioProfile[Object.keys(ratioProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(ratioProfile).length; i++){
                     if (timeStr < ratioProfile[i].time) {
                       currCarbRatio = parseFloat(ratioProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Return values
                 callback(currProfile,currBasal,currSens,currCarbRatio);
               }
               if(type == "BG") {
                 // Define current BG
                 currBG = parseInt(data[0].sgv);
                 delta30mins = parseInt(data[0].sgv)-parseInt(data[5].sgv);
                 delta60mins = parseInt(data[0].sgv)-parseInt(data[11].sgv);
                 BGtrend = data[0].direction;
                 callback(currBG,delta30mins,delta60mins,BGtrend);
               }
               
            },
            error: function(data){
            	document.getElementById("errors").innerHTML = "Derp derp derp.";
            }
            });    
      }
      
      getCustomJSON("https://beetusbot.herokuapp.com/api/v1/profile.json","profile",function(returndata){
        document.getElementById("basal").value = currBasal;
        document.getElementById("sensitivity").value = currSens;
        document.getElementById("carbRatio").value = currCarbRatio; 
      });
        
      getCustomJSON("https://beetusbot.herokuapp.com/api/v1/entries.json?count=12","BG",function(returndata){      
        document.getElementById("BG").value = currBG; 
        BGtrends();
      });
      
			var mfpCode = '';
      var mealCode = '';  
      var carbs = 0;
      var fat = 0;
      var protein = 0;
      var fiber = 0;
      
      function getMFPData(callback){
      	$.ajax({
            url: 'http://www.myfitnesspal.com/food/diary/oboe_girl4',
            method: 'GET',
            dataType: 'html',
            crossOrigin: true,
            success: function(data){
               mfpCode = data;
               callback(mfpCode);
            },
            error: function(data){
               document.getElementById("errors").innerHTML += "MyFitnessPal data could not be pulled";
            }
         }); 
      }
        
      function getMealData(mealName){
        getMFPData(function(returnData){
      		var breakfastStart = mfpCode.indexOf('<tr class="meal_header">');
        var lunchStart = mfpCode.indexOf('<tr class="meal_header">',breakfastStart+24); 
        var dinnerStart = mfpCode.indexOf('<tr class="meal_header">',lunchStart+24); 
        var aftSnackStart = mfpCode.indexOf('<tr class="meal_header">',dinnerStart+24); 
        var mornSnackStart = mfpCode.indexOf('<tr class="meal_header">',aftSnackStart+24); 
        var eveSnackStart = mfpCode.indexOf('<tr class="meal_header">',mornSnackStart+24); 
        var end = mfpCode.indexOf('<tr class="spacer">',eveSnackStart+24);
        if(mealName == "Breakfast"){ mealCode = mfpCode.substring(breakfastStart,lunchStart); }
        else if(mealName == "Lunch"){ mealCode = mfpCode.substring(lunchStart,dinnerStart); }
        else if(mealName == "Dinner"){ mealCode = mfpCode.substring(dinnerStart,aftSnackStart); }
        else if(mealName == "Afternoon Snack"){ mealCode = mfpCode.substring(aftSnackStart,mornSnackStart); }
        else if(mealName == "Morning Snack"){ mealCode = mfpCode.substring(mornSnackStart,eveSnackStart); }
        else if(mealName == "Evening Snack"){ mealCode = mfpCode.substring(eveSnackStart,end); }
        var totalsRef = mealCode.indexOf('class="quick_add_meals_list hidden">');
        // Carbs
        var carbsStart = mealCode.indexOf('<span class="macro-value">',totalsRef)+26;
        //console.log("Carbs starting index: "+carbsStart);
        var carbsEnd = mealCode.indexOf('</span>',carbsStart);
        //console.log("Carbs ending index: "+carbsEnd);
        carbs = parseFloat(mealCode.substring(carbsStart,carbsEnd));
        document.getElementById("carbs").value = carbs; 
        // Fat
        var fatStart = mealCode.indexOf('<span class="macro-value">',carbsEnd)+26;
        var fatEnd = mealCode.indexOf('</span>',fatStart);
        fat = parseFloat(mealCode.substring(fatStart,fatEnd));
        document.getElementById("fat").value = fat;  
        // Protein
        var proteinStart = mealCode.indexOf('<span class="macro-value">',fatEnd)+26;
        var proteinEnd = mealCode.indexOf('</span>',proteinStart);
        protein = parseFloat(mealCode.substring(proteinStart,proteinEnd));
        document.getElementById("protein").value = protein;  
        // Fiber
        var fiberStart = mealCode.indexOf('<td>',proteinEnd)+4;
        var fiberEnd = mealCode.indexOf('</td>',fiberStart);
        fiber = parseFloat(mealCode.substring(fiberStart,fiberEnd));
        document.getElementById("fiber").value = fiber; 
        bolusCalcWFood();
        }); 
      }
      
 			$("#BreakfastButton").click(function() { getMealData("Breakfast"); });
      $("#LunchButton").click(function() { getMealData("Lunch"); });
      $("#DinnerButton").click(function() { getMealData("Dinner"); });
      $("#MornSnackButton").click(function() { getMealData("Morning Snack"); });
      $("#AftSnackButton").click(function() { getMealData("Afternoon Snack"); });
      $("#EveSnackButton").click(function() { getMealData("Evening Snack"); });
      $("#NoMealButton").click(function() { bolusCalc(); });
      $("#TestButton").click(function() { runTest(); });

			var newBolus = 0;
      var newBolusExt = 0;
      var newBolusCorr = 0;
      var newBolusSuper = 0;
      var newBolusCarbs = 0;
      var newBolusProtein = 0;
      var additionalMessage = '';
      var addCarbs = 0;
      var trendChar = '';
      var trendText = '';
      var totalBolus = 0;
      var percentNow = 0;
      var percentExt = 0;
      
      function bolusCalcWFood(){
      	newBolus = 0;
      	newBolusExt = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	newBolusCarbs = 0;
      	newBolusProtein = 0;
      	additionalMessage = '';
        addCarbs = 0;
        totalBolus = 0;
        percentNow = 0;
        percentExt = 0;
        
        if(currBG>160){
          newBolusCorr = (currBG-100)/currSens; //Correction
          newBolusSuper = currBasal; //Super bolus
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          additionalMessage = "Super bolus, wait till bend.";
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
            additionalMessage = "Super bolus, wait till bend if possible.";
          }
        }
        else if(currBG>110){
          newBolusCorr = (currBG-100)/currSens; //Correction
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if((carbs>30) || (fat<20)){
          	newBolusSuper = currBasal; //Super bolus
            additionalMessage = "Super bolus, wait till bend if possible.";
          }
          else{
          newBolusSuper = currBasal; //Super bolus
          additionalMessage = "Super bolus if eating immediately.";
          }
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else if(currBG>70){
          newBolusCorr = (currBG-100)/currSens; //Correction
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if(carbs>30){
          	newBolusSuper = currBasal; //Super bolus
            additionalMessage = "Super bolus if eating immediately.";
          }
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else{
          newBolusCorr = (currBG-100)/currSens; //Correction UP
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        newBolus = newBolusCorr+newBolusSuper+newBolusCarbs+newBolusProtein;
        totalBolus = newBolus + newBolusExt;
        percentNow = (newBolus/totalBolus)*100;
        percentExt = (newBolusExt/totalBolus)*100;
        if(newBolus<0){
        	addCarbs = (100-currBG)/(currSens/currCarbRatio);
          document.getElementById("results").innerHTML = "Need more carbs! Eat "+addCarbs+"g. &#x1F36C";
        }
        else{
        	if(newBolusExt == 0){
          	document.getElementById("results").innerHTML = "Recommended bolus: "+ totalBolus.toFixed(2)+". "+ additionalMessage +"<br/><br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2)+"<br/>Carbs: "+newBolusCarbs.toFixed(2)+"<br/>Protein: "+newBolusProtein.toFixed(2); 
          }
          else{
          	document.getElementById("results").innerHTML = "Recommended bolus: "+ totalBolus.toFixed(2)+" ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+newBolus.toFixed(2)+" + "+newBolusExt.toFixed(2)+" extended over 2 hours. "+ additionalMessage +"<br/><br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2)+"<br/>Carbs: "+newBolusCarbs.toFixed(2)+"<br/>Protein: "+newBolusProtein.toFixed(2); 
          }
        }
      }
      
      function bolusCalc(){
      	newBolus = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	additionalMessage = '';
        addCarbs = 0;
        if(currBG>160){
          newBolusCorr = (currBG-100)/currSens;
          newBolusSuper = currBasal; //Correction + Super bolus
          additionalMessage = "Add super bolus."
        }
        else if(currBG>110){
          newBolusCorr = (currBG-100)/currSens; //Correction
        }
        else if(currBG>70){
          newBolusCorr = 0;
        }
        else{
          newBolusCorr = (currBG-100)/currSens; //Correction UP
        }
        newBolus = newBolusCorr + newBolusSuper;
        if(newBolus<0){
        	addCarbs = (100-currBG)/(currSens/currCarbRatio);
          document.getElementById("results").innerHTML = "Need more carbs! Eat "+addCarbs+"g. &#x1F36C";
        }
        else if (newBolus==0){
          document.getElementById("results").innerHTML = "All good! &#x1F600";
        }
        else{ 
          document.getElementById("results").innerHTML = "Recommended bolus: "+newBolus.toFixed(2)+". "+ additionalMessage +"<br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2);  
        }
      }
      
      function BGtrends(){
      	trendChar = '';
        trendText = '';
      	if(BGtrend == "FortyFiveUp") { currBG += 25; trendChar='&#x2197';}
        if(BGtrend == "SingleUp") { currBG += 50; trendChar='&#x2B06';}
        if(BGtrend == "DoubleUp") { currBG += 75; trendChar='&#x23EB';}
        if(BGtrend == "FortyFiveDown") { currBG -= 25; trendChar='&#x2198';}
        if(BGtrend == "SingleDown") { currBG -= 50; trendChar='&#x2B07';}
        if(BGtrend == "DoubleDown") { currBG -= 75; trendChar='&#x23EC';}
        if(BGtrend == "Flat") {trendChar='&#x27A1';}
        trendText = "<br/><br/>BG Trend: "+trendChar+"<br/>30 min delta: "+delta30mins+"<br/>60 min delta: "+delta60mins;
        document.getElementById("resultsBG").innerHTML = trendText;
      }
      
      function runTest(){
      	carbs = randomIntFromInterval(0,100);
        fat = randomIntFromInterval(0,40);
        protein = randomIntFromInterval(0,60);
        fiber = randomIntFromInterval(0,30);
        currBG = randomIntFromInterval(40,300);
        document.getElementById("carbs").value = carbs; 
        document.getElementById("fat").value = fat; 
        document.getElementById("protein").value = protein; 
        document.getElementById("fiber").value = fiber; 
        document.getElementById("BG").value = currBG; 
        bolusCalcWFood();
      }
      
      function randomIntFromInterval(min,max){
          return Math.floor(Math.random()*(max-min+1)+min);
      }
        
      })();         // End scoping function
      
      });
      
    </script>
    
  </head>
  <body>

    <b>World's most excellent form</b><br/>
    <form name="mainform" id="mainform">
      Current data from Nightscout:<br/>
      <input type="number" id="BG" placeholder="BG in mg/dL" min="0" /> BG<br/>
      <!--<input type="number" step="0.01" id="corrIOB" placeholder="Units" min="0" /> Correction IOB<br/>-->
      <input type="number" step="0.01" id="basal" placeholder="Units/hr" min="0" /> Basal units/hr<br/>
      <input type="number" id="sensitivity" placeholder="mg/dL per unit" min="0" /> Sensitivity<br/>
      <input type="number" id="carbRatio" placeholder="Carbs per unit" min="0" /> Carb Ratio<br/>
      <input type="button" id="NoMealButton" value="No meal" /><br/><br/>
      Load meal:<br/>
      <input id="BreakfastButton" type="button" value="Breakfast" /><input id="LunchButton" type="button" value="Lunch" /><br/>
      <input id="DinnerButton" type="button" value="Dinner" /><input id="MornSnackButton" type="button" value="Morning Snack" /><br/>
      <input id="AftSnackButton" type="button" value="Afternoon Snack" /><input id="EveSnackButton" type="button" value="Evening Snack" /><br/>
      Results:<br/>
      <input type="number" step="0.1" id="carbs" placeholder="Carbs in grams" min="0" /> Carbs<br/>
      <input type="number" step="0.1" id="fat" placeholder="Fat in grams" min="0" /> Fat<br/>
      <input type="number" step="0.1" id="protein" placeholder="Protein in grams" min="0" /> Protein<br/>
      <input type="number" step="0.1" id="fiber" placeholder="Fiber in grams" min="0" /> Fiber<br/><br/>
      <input type="button" id="TestButton" value="Process Test Data" /><br/><br/><input type="submit" id="submit" value="Submit to NS" /><br/>
    </form>
    
    <div id="resultsBG"></div>
    <br/>
    <div id="results"></div>
    <br/>
    <div id="errors"></div>
    
    <script>
      //console.log("Page loaded");
      $("#testform").submit(function(e) {
          e.preventDefault();
          var bg = parseFloat($("#BG").val());
          var carbs = parseFloat($("#carbs").val());
          var fat = parseFloat($("#fat").val());
          var protein = parseFloat($("#protein").val());
          var fiber = parseFloat($("#fiber").val());
          var corrIOB = parseFloat($("#corrIOB").val());
          var basal = parseFloat($("#basal").val());
          var sensitivity = parseFloat($("#sensitivity").val());
          var carbRatio = parseFloat($("#carbRatio").val());
          var CU = (carbs/10.0);
          document.getElementById("results").innerHTML = "CU: "+ CU+ "<br/>";
          //console.log("CU: "+ CU);
          var FPU = (protein*4.0+fat*9.0)/100.0;
          document.getElementById("results").innerHTML += "FPU: "+ FPU+ "<br/>";
          //console.log("FPU: "+ FPU);
          var IRFactor = (10.0/carbRatio);
          document.getElementById("results").innerHTML += "IRFactor: "+ IRFactor+ "<br/>";
          //console.log("IRFactor: "+ IRFactor);
          var CDI = (CU + FPU) * IRFactor;
          document.getElementById("results").innerHTML += "CDI: "+ CDI+ "<br/>";
          //console.log("CDI: "+ CDI);
          var CU_perc = CU / (CU + FPU);
          document.getElementById("results").innerHTML += "CU_perc: "+ CU_perc+ "<br/>";
          //console.log("CU_perc: "+ CU_perc);
          var correction = ((bg - 100)/sensitivity) - corrIOB;
          document.getElementById("results").innerHTML += "Correction: "+ correction+ "<br/>";
          //console.log("Correction: "+ correction);
          if (CU_perc < 0.2) { var NB = 0; }
          else if (CU_perc >= 0.2 && CU_perc <= 0.8) { var NB = CU * IRFactor * (1 - correction); }
          else { var NB = CU * IRFactor; }
          document.getElementById("results").innerHTML += "NB: "+ NB+ "<br/>";
          //console.log("NB: "+ NB);
          if ((FPU < 1.0) || ((FPU >= 1.0) && (CU_perc > 0.8))) { var SB = 0; }
          else if ((FPU >= 1.0) && (CU_perc < 0.2)) { var SB = FPU * IRFactor; }
          else if ((FPU >= 1.0) && (CU_perc >= 0.2) && (CU_perc <= 0.8) ) { var SB = FPU * IRFactor * (1 - correction); }
          document.getElementById("results").innerHTML += "SB: "+ SB+ "<br/>";
          //console.log("SB: "+ SB);
          if ((FPU < 1.0) || (CU_perc > 0.8)) { var T_hours = 0; }
          else if ((FPU >= 1.0) && (FPU < 2.0)) { var T_hours = 3; }
          else if ((FPU >= 2.0) && (FPU < 3.0)) { var T_hours = 4; }
          else if ((FPU >= 3.0) && (FPU < 4.0)) { var T_hours = 5; }
          else { var T_hours = 8; }
          var T_mins = T_hours * 60;
          document.getElementById("results").innerHTML += "T_hours: "+ T_hours+ "<br/>";
          //console.log("T_hours: "+ T_hours);
          console.log("Function ran");
          return false;
      });
      
    </script>
      
  </body>
</html>
