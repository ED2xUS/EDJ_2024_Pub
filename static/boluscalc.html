<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Bolus Calc Advanced</title>
    
    <link rel="shortcut icon" href="https://beetusbot.herokuapp.com/images/favicon.ico">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 

    <style>
      body {padding: 30px 30px 30px 30px;}
      input[type=submit] {width: 50%;}
      input[type=button] {width: 50%;}
      input[type=number] {width: 50%;}
      input[type=text] {width: 100%;}
      div {max-width: 300px;}
      form {max-width: 300px;}
    </style>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!--<script src="https://beetusbot.herokuapp.com/js/bootstrap.min.js"></script>-->
    <script type="text/javascript" src="https://beetusbot.herokuapp.com/js/jquery.ajax-cross-origin.min.js"></script>
    
    <script type="text/javascript">
        
      $(document).ready(function(){
	(function() { // Begin scoping function
      
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ INSTANTIATE VARIABLES ~~~~~~~~~~~~~~~~~~~~~~~~~
      
	//Static
	var BGgoal = 90;
	var hostname = location.protocol + '//' + location.host;
	var MFPurl = "http://www.myfitnesspal.com/food/diary/oboe_girl4";
	var profileURL = hostname+"/api/v1/profile.json";
	var entriesURL = hostname+"/api/v1/entries.json";
	var treatmentsURL = hostname+"/api/v1/treatments.json";
		
	//Dynamic
	var today;
      var hours = 0;
      var minutes = 0;
      var timeStr = '';
		
      var currBG = 0;
      var delta30mins = 0;
      var delta60mins = 0;
      var BGtrend = "";
      var currProfile = "";
      var currBasal = 0.0;
      var currSens = 0.0;
      var currCarbRatio = 0.0;	
		
      var mfpCode = '';
      var mealCode = '';  
      var carbs = 0;
      var fat = 0;
      var protein = 0;
      var fiber = 0;
      var eventType = '';
	var basalnotes = '';
		
	var newBolus = 0;
      var newBolusExt = 0;
      var newBolusCorr = 0;
      var newBolusSuper = 0;
      var newBolusCarbs = 0;
      var newBolusProtein = 0;
      var additionalMessage = '';
      var addCarbs = 0;
      var trendChar = '';
      var trendText = '';
      var totalBolus = 0;
      var percentNow = 0;
      var percentExt = 0;
      var prebolus = 0;
		
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ DEFINE FUNCTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~
	function getDate(){
		today = new Date(); // for now
      hours = today.getHours(); 
      if (hours < 10) { hours = "0"+hours; }
      minutes = today.getMinutes(); 
      if (minutes < 10) { minutes = "0"+minutes; }
      timeStr = hours+":"+minutes;
	}
		
	function resetVars(){
		getDate();

		getCustomJSON(profileURL,"profile",function(returndata){
	      });

	      getCustomJSON(entriesURL+"?count=12","BG",function(returndata){      
		BGtrends();
	      });

		mfpCode = '';
	      mealCode = '';  
	      resetMealData();

	      eventType = '';
		basalnotes = '';

		newBolus = 0;
		newBolusExt = 0;
		newBolusCorr = 0;
		newBolusSuper = 0;
		newBolusCarbs = 0;
		newBolusProtein = 0;
		additionalMessage = '';
		addCarbs = 0;
		totalBolus = 0;
		percentNow = 0;
		percentExt = 0;
		prebolus = 0;

		document.getElementById("submission_meal").innerHTML = "";
		document.getElementById("results_meal").innerHTML = "";
		document.getElementById("submission_correction").innerHTML = "";
		document.getElementById("results_correction").innerHTML = "";
		document.getElementById("submission_carbsonly").innerHTML = "";
		document.getElementById("submission_tempbasal").innerHTML = "";
		
	}
      
      function getCustomJSON(URL, type, callback){
        $.ajax({
            url: URL,
            method: 'GET',
            dataType: 'json',
            //crossOrigin: true,
            success: function(inputData){
              var data = inputData; //jQuery.parseJSON(inputData);
            	if(type == "profile") {
                 currProfile = data[0].defaultProfile;
                 //console.log("Type of data: " + typeof (data[0].store[currProfile].basal[1].time));
                 //console.log("Length of object: " + Object.keys(basalProfile).length);

                 // Define current basal 
                 var basalProfile = data[0].store[currProfile].basal;  
                 if(timeStr > basalProfile[Object.keys(basalProfile).length-1].time){
                     currBasal = parseFloat(basalProfile[Object.keys(basalProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(basalProfile).length; i++){
                     //console.log("Basal profile time/value "+i+ ": "+basalProfile[i].time+ " / "+basalProfile[i].value);
                     if (timeStr < basalProfile[i].time) {
                       currBasal = parseFloat(basalProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current sensitivity
                 var sensProfile = data[0].store[currProfile].sens;  
                 if(timeStr > sensProfile[Object.keys(sensProfile).length-1].time){
                     currSens = parseFloat(sensProfile[Object.keys(sensProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(sensProfile).length; i++){
                     if (timeStr < sensProfile[i].time) {
                       currSens = parseFloat(sensProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Define current carb ratio
                 var ratioProfile = data[0].store[currProfile].carbratio;  
                 if(timeStr > ratioProfile[Object.keys(ratioProfile).length-1].time){
                     currCarbRatio = parseFloat(ratioProfile[Object.keys(ratioProfile).length-1].value);
                   }
                 else{
                   for (i = 1; i < Object.keys(ratioProfile).length; i++){
                     if (timeStr < ratioProfile[i].time) {
                       currCarbRatio = parseFloat(ratioProfile[i-1].value);
                       break; 
                     }
                   }
                 }
                 // Return values
                 callback(currProfile,currBasal,currSens,currCarbRatio);
               }
               if(type == "BG") {
                 // Define current BG
                 currBG = parseInt(data[0].sgv);
                 delta30mins = parseInt(data[0].sgv)-parseInt(data[5].sgv);
                 delta60mins = parseInt(data[0].sgv)-parseInt(data[11].sgv);
                 BGtrend = data[0].direction;
                 callback(currBG,delta30mins,delta60mins,BGtrend);
               }
               
            },
            error: function(data){
            	document.getElementById("errors").innerHTML = "Derp derp derp.";
            }
            });    
      }
      
      function getMFPData(callback){
      	$.ajax({
            url: MFPurl,
            method: 'GET',
            dataType: 'html',
            crossOrigin: true,
            success: function(data){
               mfpCode = data;
               callback(mfpCode);
            },
            error: function(data){
               document.getElementById("errors").innerHTML += "MyFitnessPal data could not be pulled";
            }
         }); 
      }
        
      function getMealData(mealName){
        getMFPData(function(returnData){
      	var breakfastStart = mfpCode.indexOf('<tr class="meal_header">');
        var lunchStart = mfpCode.indexOf('<tr class="meal_header">',breakfastStart+24); 
        var dinnerStart = mfpCode.indexOf('<tr class="meal_header">',lunchStart+24); 
        var aftSnackStart = mfpCode.indexOf('<tr class="meal_header">',dinnerStart+24); 
        var mornSnackStart = mfpCode.indexOf('<tr class="meal_header">',aftSnackStart+24); 
        var eveSnackStart = mfpCode.indexOf('<tr class="meal_header">',mornSnackStart+24); 
        var end = mfpCode.indexOf('<tr class="spacer">',eveSnackStart+24);
        if(mealName == "Breakfast"){ mealCode = mfpCode.substring(breakfastStart,lunchStart); }
        else if(mealName == "Lunch"){ mealCode = mfpCode.substring(lunchStart,dinnerStart); }
        else if(mealName == "Dinner"){ mealCode = mfpCode.substring(dinnerStart,aftSnackStart); }
        else if(mealName == "Afternoon Snack"){ mealCode = mfpCode.substring(aftSnackStart,mornSnackStart); }
        else if(mealName == "Morning Snack"){ mealCode = mfpCode.substring(mornSnackStart,eveSnackStart); }
        else if(mealName == "Evening Snack"){ mealCode = mfpCode.substring(eveSnackStart,end); }
        var totalsRef = mealCode.indexOf('class="quick_add_meals_list hidden">');
        // Carbs
        var carbsStart = mealCode.indexOf('<span class="macro-value">',totalsRef)+26;
        //console.log("Carbs starting index: "+carbsStart);
        var carbsEnd = mealCode.indexOf('</span>',carbsStart);
        //console.log("Carbs ending index: "+carbsEnd);
        carbs = parseFloat(mealCode.substring(carbsStart,carbsEnd));
        document.getElementById("carbs").value = carbs; 
        // Fat
        var fatStart = mealCode.indexOf('<span class="macro-value">',carbsEnd)+26;
        var fatEnd = mealCode.indexOf('</span>',fatStart);
        fat = parseFloat(mealCode.substring(fatStart,fatEnd));
        document.getElementById("fat").value = fat;  
        // Protein
        var proteinStart = mealCode.indexOf('<span class="macro-value">',fatEnd)+26;
        var proteinEnd = mealCode.indexOf('</span>',proteinStart);
        protein = parseFloat(mealCode.substring(proteinStart,proteinEnd));
        document.getElementById("protein").value = protein;  
        // Fiber
        var fiberStart = mealCode.indexOf('<td>',proteinEnd)+4;
        var fiberEnd = mealCode.indexOf('</td>',fiberStart);
        fiber = parseFloat(mealCode.substring(fiberStart,fiberEnd));
        document.getElementById("fiber").value = fiber; 
        bolusCalcWFood();
        }); 
      }	
		
	function resetMealData(){
		carbs = 0;
		fat = 0;
		protein = 0;
		fiber = 0;
		document.getElementById("carbs").value = '';
		document.getElementById("fat").value = '';  
		document.getElementById("protein").value = '';  
		document.getElementById("fiber").value = ''; 
	}
      
      function bolusCalcWFood(){
      	newBolus = 0;
      	newBolusExt = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	newBolusCarbs = 0;
      	newBolusProtein = 0;
      	additionalMessage = '';
        addCarbs = 0;
        totalBolus = 0;
        percentNow = 0;
        percentExt = 0;
	prebolus = 0;
        
        if(currBG>160){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
          newBolusSuper = currBasal; //Super bolus
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
		prebolus = 15;
          additionalMessage = "Super bolus, wait till bend.";
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
	    prebolus = 15;
            additionalMessage = "Super bolus, wait till bend if possible.";
          }
        }
        else if(currBG>110){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if((carbs>30) || (fat<20)){
          	newBolusSuper = currBasal; //Super bolus
		  prebolus = 15;
            additionalMessage = "Super bolus, wait till bend if possible.";
          }
          else{
          newBolusSuper = currBasal; //Super bolus
          additionalMessage = "Super bolus if eating immediately.";
          }
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else if(currBG>70){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if(carbs>30){
          	newBolusSuper = currBasal; //Super bolus
            additionalMessage = "Super bolus if eating immediately.";
          }
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        else{
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction UP
          newBolusCarbs = ((carbs-(fiber/2))/currCarbRatio); //Carbs
          if(fat>20){
            newBolusExt = (((fat-20)/2)/currCarbRatio); //Fat
          }
          if((carbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
        newBolus = newBolusCorr+newBolusSuper+newBolusCarbs+newBolusProtein;
        totalBolus = newBolus + newBolusExt;
        percentNow = (newBolus/totalBolus)*100;
        percentExt = (newBolusExt/totalBolus)*100;
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
          document.getElementById("results_meal").innerHTML = "Need more carbs! Eat "+addCarbs+"g. &#x1F36C";
        }
        else{
        	if(newBolusExt == 0){
          	document.getElementById("results_meal").innerHTML = "Recommended bolus: "+ totalBolus.toFixed(2)+". "+ additionalMessage +"<br/><br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2)+"<br/>Carbs: "+newBolusCarbs.toFixed(2)+"<br/>Protein: "+newBolusProtein.toFixed(2); 
          }
          else{
          	document.getElementById("results_meal").innerHTML = "Recommended bolus: "+ totalBolus.toFixed(2)+" ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+newBolus.toFixed(2)+" + "+newBolusExt.toFixed(2)+" extended over 2 hours. "+ additionalMessage +"<br/><br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2)+"<br/>Carbs: "+newBolusCarbs.toFixed(2)+"<br/>Protein: "+newBolusProtein.toFixed(2); 
          }
	  document.getElementById("prebolus").value = prebolus;
        }
      }
      
      function bolusCalc(){
      	newBolus = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	additionalMessage = '';
        addCarbs = 0;
        if(currBG>160){
          newBolusCorr = (currBG-BGgoal)/currSens;
          newBolusSuper = currBasal; //Correction + Super bolus
          additionalMessage = "Add super bolus."
        }
        else if(currBG>110){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
        }
        else if(currBG>70){
          newBolusCorr = 0;
        }
        else{
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction UP
        }
        newBolus = newBolusCorr + newBolusSuper;
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
          document.getElementById("results_correction").innerHTML = "Need more carbs! Eat "+addCarbs+"g. &#x1F36C";
        }
        else if (newBolus==0){
          document.getElementById("results_correction").innerHTML = "All good! &#x1F600";
        }
        else{ 
          document.getElementById("results_correction").innerHTML = "Recommended bolus: "+newBolus.toFixed(2)+". "+ additionalMessage +"<br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2);
	  document.getElementById("corrdose").value = newBolus;
        }
      }
      
      function BGtrends(){
      	trendChar = '';
        trendText = '';
	var origBG = currBG;
      	if(BGtrend == "FortyFiveUp") { currBG += 25; trendChar='&#x2197';}
        if(BGtrend == "SingleUp") { currBG += 50; trendChar='&#x2B06';}
        if(BGtrend == "DoubleUp") { currBG += 75; trendChar='&#x23EB';}
        if(BGtrend == "FortyFiveDown") { currBG -= 25; trendChar='&#x2198';}
        if(BGtrend == "SingleDown") { currBG -= 50; trendChar='&#x2B07';}
        if(BGtrend == "DoubleDown") { currBG -= 75; trendChar='&#x23EC';}
        if(BGtrend == "Flat") {trendChar='&#x27A1';}
        trendText = "BG: "+origBG+"<br/>BG Trend: "+trendChar+"<br/>30 min delta: "+delta30mins+"<br/>60 min delta: "+delta60mins;
        document.getElementById("resultsBG").innerHTML = trendText;
      }
		
	function setTemp(type){
		if(type == "Engine Braking"){
			document.getElementById("basalduration").value = 30; 
			document.getElementById("basalpercent").value = -100; 	
			basalnotes = "Engine Braking";
		}
		if(type == "Super Bolus"){
			document.getElementById("basalduration").value = 60; 
			document.getElementById("basalpercent").value = -100; 
			basalnotes = "Super Bolus";
		}
	}
	
	function randomIntFromInterval(min,max){
          return Math.floor(Math.random()*(max-min+1)+min);
      }
		
	function runTest(){
      	carbs = randomIntFromInterval(0,100);
        fat = randomIntFromInterval(0,40);
        protein = randomIntFromInterval(0,60);
        fiber = randomIntFromInterval(0,30);
        currBG = randomIntFromInterval(40,300);
        document.getElementById("carbs").value = carbs; 
        document.getElementById("fat").value = fat; 
        document.getElementById("protein").value = protein; 
        document.getElementById("fiber").value = fiber; 
        document.getElementById("BG").value = currBG; 
        bolusCalcWFood();
      }

	function sendExercise(event,type){
		eventType = "Exercise"; 
	      event.preventDefault();
	  var exercisetime = document.getElementById("exerciseduration").value;
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":exercisetime,"notes":type,"eventType":eventType,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_exercise").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_exercise").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	}
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ RUN FUNCTIONS ON PAGE LOAD ~~~~~~~~~~~~~~~~~~~~~~~~~
		
	getCustomJSON(profileURL,"profile",function(returndata){
        /*document.getElementById("basal").value = currBasal;
        document.getElementById("sensitivity").value = currSens;
        document.getElementById("carbRatio").value = currCarbRatio; */
      });
        
      getCustomJSON(entriesURL+"?count=12","BG",function(returndata){      
        //document.getElementById("BG").value = currBG; 
        BGtrends();
      });
		
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ SET BUTTON ACTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~	
		
      $("#BreakfastButton").click(function() { resetVars(); eventType = "Meal Bolus"; getMealData("Breakfast"); });
      $("#LunchButton").click(function() { resetVars(); eventType = "Meal Bolus"; getMealData("Lunch");  });
      $("#DinnerButton").click(function() { resetVars(); eventType = "Meal Bolus"; getMealData("Dinner");  });
      $("#MornSnackButton").click(function() { resetVars(); eventType = "Snack Bolus"; getMealData("Morning Snack"); });
      $("#AftSnackButton").click(function() { resetVars(); eventType = "Snack Bolus"; getMealData("Afternoon Snack"); });
      $("#EveSnackButton").click(function() { resetVars(); eventType = "Snack Bolus"; getMealData("Evening Snack"); });
      $("#CorrOnly").click(function() { resetVars(); eventType = "Correction Bolus"; bolusCalc(); });
      $("#EngineBraking").click(function() { eventType = "Temp Basal Start"; setTemp("Engine Braking"); });
      $("#SuperBolus").click(function() { eventType = "Temp Basal Start"; setTemp("Super Bolus"); });
      //$("#TestButton").click(function() { eventType = "Meal Bolus"; runTest(); });
      $("#Dance").click(function(event) { 
	      eventType = "Exercise"; 
	      event.preventDefault();
	  var exercisetime = document.getElementById("exerciseduration").value;
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":exercisetime,"notes":"Dance","eventType":eventType,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_exercise").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_exercise").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
      });
      $("#Yoga").click(function(event) { 
	     sendExercise(event,"Yoga"); 
      });
      $("#Other").click(function(event) { 
	      eventType = "Exercise"; 
	      event.preventDefault();
	  var exercisetime = document.getElementById("exerciseduration").value;
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":exercisetime,"notes":"Other","eventType":eventType,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_exercise").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_exercise").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
      });	
      $("#mealform").submit(function( event ) {
          event.preventDefault();
	  var $form = $( this ),
	    prebolus = $form.find( "select[id='prebolus']" ).val();
	  var finalCarbs = (carbs-(fiber/2));
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":finalCarbs,"insulin":newBolus,"eventType":eventType,"preBolus":prebolus,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_meal").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_meal").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	      if(newBolusSuper>0){
		  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":eventType,"notes":basalnotes,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
		  // Put the results in a div
		  posting2.done(function( data ) {
		    document.getElementById("submission_correction").innerHTML += " plus super bolus temp basal.";
		  }); 
		  posting2.fail(function( data) {
		    document.getElementById("submission_correction").innerHTML += " WITHOUT super bolus temp basal.";  
		  });
	  }
        });
	$("#correctionform").submit(function( event ) {
          // Stop form from submitting normally
          event.preventDefault();
          // Get some values from elements on the page
	  var $form = $( this ),
	    corrdose = $form.find( "input[id='corrdose']" ).val();
          // Send the data using post 
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":corrdose,"eventType":eventType,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          // Put the results in a div
          posting.done(function( data ) {
            document.getElementById("submission_correction").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_correction").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	      
	  if(newBolusSuper>0){
		  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":eventType,"notes":basalnotes,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
		  // Put the results in a div
		  posting2.done(function( data ) {
		    document.getElementById("submission_correction").innerHTML += " plus super bolus temp basal.";
		  }); 
		  posting2.fail(function( data) {
		    document.getElementById("submission_correction").innerHTML += " WITHOUT super bolus temp basal.";  
		  });
	  }
        });	
	$("#carbsonlyform").submit(function( event ) {
          event.preventDefault();
	  var $form = $( this ),
	    corrCarbs = $form.find( "input[id='corrCarbs']" ).val();
	  eventType = "Carb Correction";
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":corrCarbs,"eventType":eventType,"notes":"Low","secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_carbsonly").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_carbsonly").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
	$("#tempbasalform").submit(function( event ) {
          event.preventDefault();
	  var $form = $( this ),
	    basald = $form.find( "input[id='basalduration']" ).val(),
	    basalp = $form.find( "input[id='basalpercent']" ).val();
	  if(eventType == '') { eventType = "Temp Basal Start"; }
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":basald,"percent":basalp,"eventType":eventType,"notes":basalnotes,"secret":"c96c4972f2f35a0b74e91b75dccf0d3807a16ad1" } );
          posting.done(function( data ) {
            document.getElementById("submission_tempbasal").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_tempbasal").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
      
      })();         // End scoping function
      
      });
      
    </script>
    
  </head>
  <body>

    <div id="resultsBG"></div>
	  <br/>
    <b>Meal or Snack</b><br/>
    <form id="mealform">
      Load meal:<br/>
      <input id="BreakfastButton" type="button" value="Breakfast" /><input id="LunchButton" type="button" value="Lunch" /><br/>
      <input id="DinnerButton" type="button" value="Dinner" /><input id="MornSnackButton" type="button" value="Morning Snack" /><br/>
      <input id="AftSnackButton" type="button" value="Afternoon Snack" /><input id="EveSnackButton" type="button" value="Evening Snack" /><br/>
      Results:<br/>
      <input type="number" step="0.1" id="carbs" placeholder="Carbs in grams" min="0" /> Carbs<br/>
      <input type="number" step="0.1" id="fat" placeholder="Fat in grams" min="0" /> Fat<br/>
      <input type="number" step="0.1" id="protein" placeholder="Protein in grams" min="0" /> Protein<br/>
      <input type="number" step="0.1" id="fiber" placeholder="Fiber in grams" min="0" /> Fiber<br/>
	<select id="prebolus">
	  <option value="0" selected="selected">0</option>
	  <option value="5">5</option>
		<option value="10">10</option>
		<option value="15">15</option>
		<option value="20">20</option>
		<option value="25">25</option>
		<option value="30">30</option>
	</select> Carb time   
	    <br/>
      <!--<input type="button" id="TestButton" value="Process Test Data" /><br/><br/>-->
      <input type="submit" id="submit_meal" value="Submit meal/snack" /><br/>
    </form>
    <div id="submission_meal"></div>
    <br/>
    <div id="results_meal"></div>
	  <br/>
    <b>Correction Only</b><br/>	  
    <form id="correctionform">
	    <input type="number" id="corrdose" step="0.01" min="0" /> Units<br/>
	    <input type="button" id="CorrOnly" value="Suggest correction" />
	    <input type="submit" id="submit_correction" value="Submit correction" />
	  </form>
	  <div id="submission_correction"></div>
	  <br/>
    <div id="results_correction"></div>
	  <br/>
<b>Carbs Only</b><br/>	
	<form id="carbsonlyform">
	<input type="number" step="0.1" id="corrCarbs" placeholder="Carbs in grams" min="0" value="8"/> Carbs<br/>
	<input type="submit" id="submit_carbs" value="Submit carbs" /><br/>
	  </form>
	  <div id="submission_carbsonly"></div>
	  <br/>
	  <b>Temp Basal</b><br/>	
	<form id="tempbasalform">
	<input type="number" id="basalduration" placeholder="Duration in minutes" min="0" /> Duration<br/>
      	<input type="number" id="basalpercent" placeholder="Basal change in %" min="-100" /> % Change<br/>
	<input type="button" id="EngineBraking" value="Engine braking" /><input type="button" id="SuperBolus" value="Super bolus" /><br/>	
	<input type="submit" id="submit_tempbasal" value="Submit" /><br/>
	  </form>
	  <div id="submission_tempbasal"></div>
    <br/>
	  <b>Exercise</b><br/>	
	<form id="exerciseform">
	<input type="number" id="exerciseduration" placeholder="Duration in minutes" min="0" /> Duration<br/>
	<input type="button" id="Dance" value="Dance" /><input type="button" id="Yoga" value="Yoga" /><br/>
	<input type="button" id="Other" value="Other" />
	  </form>
	  <div id="submission_exercise"></div>
    <br/>
	  
	  <div id="errors"></div>

  </body>
</html>
