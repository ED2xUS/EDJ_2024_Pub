<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bolus Calc Advanced</title>
<link rel="shortcut icon" href="https://beetusbot.herokuapp.com/images/favicon.ico">
<!-- Bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 
<link rel="stylesheet" href="https://beetusbot.herokuapp.com/css/boluscalcstyle.css"> 
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<!--<script src="https://beetusbot.herokuapp.com/js/bootstrap.min.js"></script>-->
<script type="text/javascript" src="https://beetusbot.herokuapp.com/js/jquery.ajax-cross-origin.min.js"></script>
<script type="text/javascript" src="https://beetusbot.herokuapp.com/js/processdata.js"></script>
<script type="text/javascript">
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ INSTANTIATE VARIABLES ~~~~~~~~~~~~~~~~~~~~~~~~~
	//Static
	var BGgoal = 90;
	var hostname = location.protocol + '//' + location.host;
	var MFPurl = "http://www.myfitnesspal.com/food/diary/oboe_girl4";
	var profileURL = hostname+"/api/v1/profile.json";
	var entriesURL = hostname+"/api/v1/entries.json";
	var treatmentsURL = hostname+"/api/v1/treatments.json";
	var secret = "c96c4972f2f35a0b74e91b75dccf0d3807a16ad1";	
	//Dynamic
	//Time
	var today;
	var hours = 0;
	var minutes = 0;
	var timeStr = '';
	var UTCtimeStr = '';
	//Stats	
	var currBG = 0;
	var delta30mins = 0;
	var delta60mins = 0;
	var BGtrend = "";
	var currProfile = "";
	var currBasal = 0.0;
	var currSens = 0.0;
	var currCarbRatio = 0.0;
	var timestamp = '';
	var upperBGgoal = 0;
	var lowerBGgoal = 0;
	var treatmentsArray;
	var activeInsulinHours = 0;
	//Food	
	var mfpCode = '';
	var mealCode = '';  
	var carbs = 0;
	var fat = 0;
	var protein = 0;
	var fiber = 0;
	var netCarbs = 0;
	//Dosing
	var eventType = '';
	var newBolus = 0;
	var newBolusExt = 0;
	var newBolusCorr = 0;
	var newBolusSuper = 0;
	var newBolusCarbs = 0;
	var newBolusProtein = 0;
	var newBolusFat = 0;
	var additionalMessage = '';
	var addCarbs = 0;
	var trendChar = '';
	var trendText = '';
	var totalBolus = 0;
	var percentNow = 0;
	var percentExt = 0;
	var prebolus = 0;
	var basalnotes = '';	
	var exerciseSuggestion = '';
	var exerciseType = '';
	var extBolusTime = 120;
	
$(document).ready(function(){
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ DEFINE FUNCTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~
	// Set date/time
	function getDate(){
		today = new Date(); // for now
	    	hours = today.getHours(); 
	    	if (hours < 10) { hours = "0"+hours; }
	    	minutes = today.getMinutes(); 
	    	if (minutes < 10) { minutes = "0"+minutes; }
	    	timeStr = hours+":"+minutes;
		UTCtimeStr = today.toJSON();
	} // end getDate
	// Clear divs without resetting all variables      
    	function cleardivs(exception){
		document.getElementById("submission_meal").innerHTML = "";
	    	if(exception != "Meal") { 
			document.getElementById("results_meal").innerHTML = ""; 
			$("#results_mealdose").hide();
		}
		document.getElementById("submission_correction").innerHTML = "";
		if(exception != "Correction") { document.getElementById("results_correction").innerHTML = ""; }
		document.getElementById("submission_carbsonly").innerHTML = "";
	    	if(exception != "Carbs") { document.getElementById("results_carbs").innerHTML = ""; }
		document.getElementById("submission_tempbasal").innerHTML = "";
		if(exception != "Exercise") { document.getElementById("submission_exercise").innerHTML = ""; }
		document.getElementById("submission_removepump").innerHTML = "";
		document.getElementById("errors").innerHTML = "";
	} // end cleardivs
	// Refresh/reset all data and fields	  
	function resetVars(){
		// Time
		getDate(); 
		//Stats
		getCustomJSON(profileURL,"profile",function(returndata){
			if(returndata == "Error pulling stats"){
				document.getElementById("errors").innerHTML = returndata + " - Profile";
			}
	      	});

	      	getCustomJSON(entriesURL+"?count=12","BG",function(returndata){ 
			if(returndata != "Error pulling stats"){
				trendText = BGtrends();
				document.getElementById("resultsBG").innerHTML = trendText;
			}
			else{
				document.getElementById("errors").innerHTML = returndata + " - Entries";	
			}
	      	});

		getCustomJSON(treatmentsURL,"Treatments",function(returndata){ 
			if(returndata != "Error pulling stats"){
				treatmentsArray = returndata;
				processTreatments(treatmentsArray);
			}
			else{
				document.getElementById("errors").innerHTML = returndata + " - Treatments";	
			}
	      	});
		//Food
		mfpCode = '';
	    	mealCode = '';  
	    	resetMealData();
		//Dosing
	    	eventType = '';
		newBolus = 0;
		newBolusExt = 0;
		newBolusCorr = 0;
		newBolusSuper = 0;
		newBolusCarbs = 0;
		newBolusProtein = 0;
		newBolusFat = 0;
		additionalMessage = '';
		addCarbs = 0;
		totalBolus = 0;
		percentNow = 0;
		percentExt = 0;
		prebolus = 0;
		basalnotes = '';
		exerciseSuggestion = '';
		exerciseType = '';
		//Clear basal values if needed
		document.getElementById("basalduration").value = "";
		document.getElementById("basalpercent").value = "";
		//Clear all submission/result divs
		cleardivs("N/A");
	} // end resetVars   	
    	
	// Clear meal data values	
	function resetMealData(){
		carbs = 0;
		fat = 0;
		protein = 0;
		fiber = 0;
		netCarbs = 0;
		document.getElementById("carbs").value = 0;
		document.getElementById("fat").value = 0;  
		document.getElementById("protein").value = 0;  
		document.getElementById("fiber").value = 0;
		//document.getElementById("prebolus").value = 0;
	} // end resetMealData
      
	function bolusCalcWFood(mealName){
		// Clear old data 
		newBolus = 0;
		newBolusExt = 0;
		newBolusCorr = 0;
		newBolusSuper = 0;
		newBolusCarbs = 0;
		newBolusProtein = 0;
		newBolusFat = 0;
		additionalMessage = '';
		addCarbs = 0;
		totalBolus = 0;
		percentNow = 0;
		percentExt = 0;
		netCarbs = 0;
		extBolusTime = 120;
		// Calculate net carbs
		if(mealName == "Breakfast"){ 
			netCarbs = carbs - (fiber / 2); 
		}
		else{
			netCarbs = carbs-fiber;
		}
		// Calculate carb and correction base doses
		newBolusCorr = (currBG-BGgoal)/currSens; //Correction
		newBolusCarbs = netCarbs/currCarbRatio; //Carbs
	      
        	if(currBG>160){  
          		newBolusSuper = currBasal; //Super bolus
          		additionalMessage = "Super bolus, wait till bend.";
          		if((netCarbs<=20) && (protein>20)){ 
            			newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
            			additionalMessage = "Super bolus, wait till bend if possible.";
          		}
        	}
        	else if(currBG>110){
          		if((netCarbs>30) || (fat<20)){
				if((prebolus < 10) && (fat<20)){ //Super bolus 
					newBolusSuper = currBasal; 
					additionalMessage = "Super bolus, wait till bend if possible.";		       
				} 
				else{
					additionalMessage = "Wait till bend if possible.";
				}
				if(prebolus>10){
					additionalMessage = "Wait till bend if possible.";
				}
          		}
          		else{
		  		if(prebolus < 10){  
					newBolusSuper = currBasal;	
					additionalMessage = "Super bolus if eating immediately.";
				} //Super bolus 
          		}
          		if((netCarbs<=20) && (protein>20)){ 
            			newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          		}
        	}
        	else if(currBG>70){
          		if(netCarbs>30){
          			if(prebolus < 10){  
					newBolusSuper = currBasal;	
					additionalMessage = "Super bolus if eating immediately.";
				} //Super bolus 	
          		}
          		if((netCarbs<=20) && (protein>20)){ 
            			newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          		}
        	}
        	else{
          if((netCarbs<=20) && (protein>20)){ 
            newBolusProtein = ((protein-20)/2)/currCarbRatio; //Protein
          }
        }
	if(fat>20){
            //newBolusFat = (((fat-20)/2)/currCarbRatio); //Fat
	      newBolusFat = newBolusCarbs*.2;
	      newBolusCarbs = newBolusCarbs*.8;
          }
	if(mealName == "Breakfast"){
		newBolusCarbs = newBolusCarbs+newBolusProtein;
		newBolus = newBolusCorr+newBolusSuper+newBolusCarbs;
		newBolusExt = newBolusFat;
	}
	else{	
        	newBolus = newBolusCorr+newBolusSuper+newBolusCarbs;
		newBolusExt = newBolusFat+newBolusProtein;
	}
        totalBolus = newBolus + newBolusExt;
        percentNow = Math.round((newBolus/totalBolus)*100);
        percentExt = 100-percentNow; ((newBolusExt/totalBolus)*100);
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
          	document.getElementById("results_meal").innerHTML = "<br/>Need more carbs! Eat "+addCarbs.toFixed(0)+"g. &#x1F36C";
        }
        else{	
	  var extBolusText = '';
	  if(newBolusExt > 0){
		  extBolusText = " ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+newBolus.toFixed(2)+" + "+newBolusExt.toFixed(2)+" extended over 2 hours. ";
	  }
	  else{ extBolusText = ". "; extBolusTime = "N/A"; }	

          	document.getElementById("results_meal").innerHTML = "<br/>Recommended bolus: "
			+ totalBolus.toFixed(2)+ extBolusText + additionalMessage;
		$("#results_mealdose").show();
		document.getElementById("carbdose_meal").value = newBolusCarbs.toFixed(2);
		document.getElementById("extdose_meal").value = newBolusExt.toFixed(2);
		document.getElementById("corrdose_meal").value = newBolusCorr.toFixed(2);
		document.getElementById("super_meal").value = newBolusSuper.toFixed(2);
		document.getElementById("bolusnow_meal").value = percentNow.toFixed(0);
		document.getElementById("bolusext_meal").value = percentExt.toFixed(0);
			
        }
	document.getElementById("extBolusTime").value = extBolusTime;
      }
      
      function bolusCalc(){
      	newBolus = 0;
      	newBolusCorr = 0;
      	newBolusSuper = 0;
      	additionalMessage = '';
        addCarbs = 0;
        if(currBG>160){
          newBolusCorr = (currBG-BGgoal)/currSens;
          newBolusSuper = currBasal; //Correction + Super bolus
          additionalMessage = "Add super bolus."
        }
        else if(currBG>110){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction
        }
        else if(currBG>70){
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction, maybe UP
        }
        else{
          newBolusCorr = (currBG-BGgoal)/currSens; //Correction UP
        }
        newBolus = newBolusCorr + newBolusSuper;
	var divToWriteTo = '';
	if(eventType == "Carb Correction") { divToWriteTo = 'results_carbs'; }
	if(eventType == "Correction Bolus") { divToWriteTo = 'results_correction'; }      
        if(newBolus<0){
        	addCarbs = (BGgoal-currBG)/(currSens/currCarbRatio);
		document.getElementById(divToWriteTo).innerHTML = "<br/>Need more carbs! Eat "+addCarbs.toFixed(0)+"g. &#x1F36C";
		document.getElementById("corrCarbs").value = addCarbs.toFixed(0); 	
        }
        else if (newBolus==0){
	  if(eventType == "Carb Correction") { document.getElementById(divToWriteTo).innerHTML = "<br/>No carbs needed!"; }	
          if(eventType == "Correction Bolus") { document.getElementById(divToWriteTo).innerHTML = "<br/>No insulin needed!"; }
        }
        else{ 
	  if(eventType == "Carb Correction") { document.getElementById(divToWriteTo).innerHTML = "<br/>No carbs needed!"; }
	  if(eventType == "Correction Bolus") { 
		document.getElementById(divToWriteTo).innerHTML = "<br/>Recommended bolus: "+newBolus.toFixed(2)+". "+ additionalMessage +"<br/>Correction: "+newBolusCorr.toFixed(2)+"<br/>Super: "+newBolusSuper.toFixed(2);
	  	document.getElementById("corrdose").value = newBolus.toFixed(2); 
	  }   	 
        }
      }
		
	function setTemp(type){
		if(type == "Engine Braking"){
			document.getElementById("basalduration").value = 30; 
			document.getElementById("basalpercent").value = -100; 	
			basalnotes = "Engine Braking";
		}
		if(type == "Super Bolus"){
			document.getElementById("basalduration").value = 60; 
			document.getElementById("basalpercent").value = -100; 
			basalnotes = "Super Bolus";
		}
	}
	
	function randomIntFromInterval(min,max){
          return Math.floor(Math.random()*(max-min+1)+min);
      }
		
	function runTest(){
		carbs = randomIntFromInterval(0,100);
		fat = randomIntFromInterval(0,40);
		protein = randomIntFromInterval(0,60);
		fiber = randomIntFromInterval(0,30);
		currBG = randomIntFromInterval(40,300);
		document.getElementById("carbs").value = carbs; 
		document.getElementById("fat").value = fat; 
		document.getElementById("protein").value = protein; 
		document.getElementById("fiber").value = fiber; 
		document.getElementById("BG").value = currBG; 
		bolusCalcWFood("Test");
      }

	function suggestExercise(){
	  eventType = "Exercise"; 
	  var exercisetime = document.getElementById("exerciseduration").value;
	  if(exerciseType == "Dance"){
		 exerciseSuggestion = "Expect a BG drop of "+ exercisetime + " to be adjusted by " + (exercisetime/currSens).toFixed(2) + " less insulin or " + (exercisetime/(currSens/currCarbRatio)).toFixed(0) + " carbs. Set a 12 hour post-exercise temp basal of -20%."
	  }
	  if(exerciseType == "Yoga"){
		 exerciseSuggestion = "30 mins prior to end of session, if BGs have not been dropping, do 2 units to cover post exercise high. Set a 12 hour post-exercise temp basal of -10%."
	  }
	  if(exerciseType == "Other"){
		  exerciseSuggestion = "If aerobic, expect a BG drop of "+ exercisetime + " to be adjusted by " + (exercisetime/currSens).toFixed(2) + " less insulin or " + (exercisetime/(currSens/currCarbRatio)).toFixed(0) + " carbs. Set a 12 hour post-exercise temp basal of -20%.<br/><br/>If anaerobic, 30 mins prior to end of session, if BGs have not been dropping, do 2 units to cover post exercise high. Set a 12 hour post-exercise temp basal of -10%."
	  }
          document.getElementById("submission_exercise").innerHTML = exerciseSuggestion; 
	}
			
		
	function postData(input, callback){
			var posting = $.post( treatmentsURL, input );
			  posting.done(function( data ) {
			    callback(data);
			  }); 
			  posting.fail(function( data) {
			    callback(data);
			  });
	}
	      
	function calcFoodBolus(mealOrSnack, name){
	      resetVars(); 
	      eventType = mealOrSnack+" Bolus"; 
	      prebolus = document.getElementById("prebolus").value;
	      getMealData(name, function(data){
		   if (data != "<br/>No meal data available."){
		      /*carbs = carbs;
		      fat = fat; 
		      protein = protein; 
		      fiber = fiber; */
		      document.getElementById("carbs").value = carbs; 
		      document.getElementById("fat").value = fat; 
		      document.getElementById("protein").value = protein;  
		      document.getElementById("fiber").value = fiber; 
		      bolusCalcWFood(name);
	      }
	      else{
		    document.getElementById("errors").innerHTML = "Couldn't get meal results";  
	      }   
	      });
	      
      }
	
	function processTreatments(data){
		var eventsToSearchFor = [];
		var timeSinceWarning = ''; 
		var timeSince = '';
		var diff = 0;
		var diffFood = 0;
		var thelength = Object.keys(data).length;
		var JStimestamp;
		var prevString = '';
		var minutes;
		eventsToSearchFor = ["Meal Bolus","Snack Bolus","Combo Bolus"];
		var IOBfood = 0;
		var IOBcorr = 0;
		var peak = 75;
		var scaleFactor = 3.0/activeInsulinHours;
		var minAgo = 0;
		var mealFound = 0;
		var x1 = 0;
		var x2 = 0;
		var IOBstring = '';
		
		dataLoop: for(i = 0; i < thelength; i++){
			searchLoop: for (j = 0; j < eventsToSearchFor.length; j++){
				JStimestamp = new Date(data[i].created_at);
				diff = Math.abs(today-JStimestamp);
				minutes = Math.round(Math.floor((diff/1000)/60)); 
				minAgo = scaleFactor*minutes;
				if ((data[i].eventType == eventsToSearchFor[j]) && (mealFound == 0)){
					JStimestamp = new Date(data[i].created_at);
					diffFood = Math.abs(today-JStimestamp);
					mealFound = 1;
				}
				//console.log(minutes + " / "+ data[i].eventType + " / "+ data[i].insulin + " event type: "+ typeof(data[i].eventType));
				if ((parseFloat(data[i].insulin) > 0) && (minutes<(activeInsulinHours*60)) && (data[i].eventType == eventsToSearchFor[j])){
					if(minAgo < peak){
						x1 = (minAgo/5) + 1;
						IOBfood += parseFloat(data[i].insulin)*(1 - 0.001852 * x1 * x1 + 0.001852 * x1);	
					}
					else if (minAgo < 180){
						x2 = (minAgo - peak) / 5;
						IOBfood += parseFloat(data[i].insulin)*(0.001323 * x2 * x2 - 0.054233 * x2 + 0.55556);	
					}	
				}	
			}
			if ((parseFloat(data[i].insulin) > 0) && (minutes<(activeInsulinHours*60)) && (data[i].eventType === undefined)){ // undefined for combo bolus extended entered by BolusCalc
					if(minAgo < peak){
						x1 = (minAgo/5) + 1;
						IOBfood += parseFloat(data[i].insulin)*(1 - 0.001852 * x1 * x1 + 0.001852 * x1);	
					}
					else if (minAgo < 180){
						x2 = (minAgo - peak) / 5;
						IOBfood += parseFloat(data[i].insulin)*(0.001323 * x2 * x2 - 0.054233 * x2 + 0.55556);	
					}	
				}
			if ((parseFloat(data[i].insulin) > 0) && (minutes<(activeInsulinHours*60)) && (data[i].eventType == "Correction Bolus")){
					if(minAgo < peak){
						x1 = (minAgo/5) + 1;
						IOBcorr += parseFloat(data[i].insulin)*(1 - 0.001852 * x1 * x1 + 0.001852 * x1);	
					}
					else if (minAgo < 180){
						x2 = (minAgo - peak) / 5;
						IOBcorr += parseFloat(data[i].insulin)*(0.001323 * x2 * x2 - 0.054233 * x2 + 0.55556);	
					}	
				}
			if ((minutes>(activeInsulinHours*60)) && (mealFound == 1)){ break dataLoop; }
		}
			minutes = Math.round(Math.floor((diffFood/1000)/60));  
			if((minutes>120) && (currBG>upperBGgoal)){
				timeSinceWarning = "<br/>&#x2757 post prandial BG above limit";
			}
			if(minutes<60){
				timeSince = minutes+" minutes";
			}
			else{
				timeSince = Math.floor(minutes/60)+ " hours, "+(minutes%60)+" minutes";
			}
			if(IOBfood > 0){
				IOBstring += "IOB (food): "+IOBfood.toFixed(2)+"&nbsp;&nbsp;&nbsp;";
			}
			if(IOBcorr > 0){
				IOBstring += "IOB (correction): " + IOBcorr.toFixed(2);
			}
		prevString = document.getElementById("resultsBG").innerHTML;
		document.getElementById("resultsBG").innerHTML = prevString.substring(0, prevString.length-20) + timeSince+timeSinceWarning+"<br/>"+IOBstring;
	}
	
	// ~~~~~~~~~~~~~~~~~~~~~~~~~ RUN FUNCTIONS ON PAGE LOAD ~~~~~~~~~~~~~~~~~~~~~~~~~
		
	getDate();
		
	getCustomJSON(profileURL,"profile",function(returndata){
			if(returndata == "Error pulling stats"){
				document.getElementById("errors").innerHTML = returndata + " - Profile";
			}
	      	});

	      	getCustomJSON(entriesURL+"?count=12","BG",function(returndata){ 
			if(returndata != "Error pulling stats"){
				trendText = BGtrends();
				document.getElementById("resultsBG").innerHTML = trendText;
			}
			else{
				document.getElementById("errors").innerHTML = returndata + " - Entries";	
			}
	      	});

		getCustomJSON(treatmentsURL,"Treatments",function(returndata){ 
			if(returndata != "Error pulling stats"){
				treatmentsArray = returndata;
				processTreatments(treatmentsArray);
			}
			else{
				document.getElementById("errors").innerHTML = returndata + " - Treatments";	
			}
	      	});
	

	// ~~~~~~~~~~~~~~~~~~~~~~~~~ SET BUTTON ACTIONS ~~~~~~~~~~~~~~~~~~~~~~~~~	
		
      $("#BreakfastButton").click(function() { calcFoodBolus("Meal", "Breakfast"); });
      $("#LunchButton").click(function() { calcFoodBolus("Meal", "Lunch");  });
      $("#DinnerButton").click(function() { calcFoodBolus("Meal", "Dinner");  });
      $("#MornSnackButton").click(function() { calcFoodBolus("Snack", "Morning Snack"); });
      $("#AftSnackButton").click(function() { calcFoodBolus("Snack", "Afternoon Snack"); });
      $("#EveSnackButton").click(function() { calcFoodBolus("Snack", "Evening Snack"); });
      $("#suggest_meal").click(function() { 
	        prebolus = document.getElementById("prebolus").value;
		carbs = document.getElementById("carbs").value;
		fat = document.getElementById("fat").value;  
		protein = document.getElementById("protein").value;  
		fiber = document.getElementById("fiber").value;
	        eventType = "Meal Bolus";
	      	bolusCalcWFood("N/A");
      });  
      $("#carbdose_clear").click(function() { document.getElementById("carbdose_meal").value = 0.00; });
	$("#extdose_clear").click(function() { document.getElementById("extdose_meal").value = 0.00; });
	$("#corrdose_clear").click(function() { document.getElementById("corrdose_meal").value = 0.00; });
	$("#superdose_clear").click(function() { document.getElementById("super_meal").value = 0.00; });
	$("#combosplit_clear").click(function() { 
		document.getElementById("bolusnow_meal").value = 100; 
		document.getElementById("bolusext_meal").value = 0; 				
	});
	(document.getElementById("bolusnow_meal")).addEventListener("input", function(e){
		document.getElementById("bolusext_meal").value = 100-document.getElementById("bolusnow_meal").value;
	});
	(document.getElementById("bolusext_meal")).addEventListener("input", function(e){
		document.getElementById("bolusnow_meal").value = 100-document.getElementById("bolusext_meal").value;
	});
      $("#CorrOnly").click(function() { resetVars(); eventType = "Correction Bolus"; bolusCalc(); });
      $("#CarbsOnly").click(function() { resetVars(); eventType = "Carb Correction"; bolusCalc(); });
      $("#EngineBraking").click(function() { resetVars(); eventType = "Temp Basal"; setTemp("Engine Braking"); });
      $("#SuperBolus").click(function() { resetVars(); eventType = "Temp Basal"; setTemp("Super Bolus"); });
      //$("#TestButton").click(function() { eventType = "Meal Bolus"; runTest(); });
      $("#Dance").click(function(event) { 
	      resetVars();
	      exerciseType = "Dance";
	      suggestExercise();
      });
      $("#Yoga").click(function(event) { 
	      resetVars();
	      exerciseType = "Yoga";
	     suggestExercise();
      });
      $("#Other").click(function(event) { 
	      resetVars();
	      exerciseType = "Other";
	      suggestExercise();
      });	
      $("#mealform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("Meal");
	  var $form = $( this ),
	  prebolus = $form.find( "select[id='prebolus']" ).val(),
	  finalcarbdose = parseFloat($form.find( "input[id='carbdose_meal']" ).val()),
	      finalextdose = parseFloat($form.find( "input[id='extdose_meal']" ).val()),
	      finalcorrdose = parseFloat($form.find( "input[id='corrdose_meal']" ).val()),
	      finalsuperdose = parseFloat($form.find( "input[id='super_meal']" ).val()),
	      finalbolusnowpercent = parseInt($form.find( "input[id='bolusnow_meal']" ).val()),
	      finalbolusextpercent = parseInt($form.find( "input[id='bolusext_meal']" ).val()),
	      finalextbolustime = parseInt($form.find( "select[id='extBolusTime']" ).val()) ;       
	  var newTotal = 0;
	  var newNow = 0;
	  var prevTotal = finalcarbdose+finalextdose;
	  if((finalcarbdose != parseFloat(newBolusCarbs.toFixed(2))) || (finalextdose != parseFloat(newBolusExt.toFixed(2))) || (finalcorrdose != parseFloat(newBolusCorr.toFixed(2))) || (finalsuperdose != parseFloat(newBolusSuper.toFixed(2))) || (finalbolusnowpercent != percentNow) || (finalbolusextpercent != percentExt) || (finalextbolustime != extBolusTime)){
		  if((finalbolusnowpercent != percentNow) || (finalbolusextpercent != percentExt)){
			finalextdose = prevTotal * (finalbolusextpercent/100);
			finalcarbdose = prevTotal * (finalbolusnowpercent/100);
			//finalextdose = finalextdose+(finalcarbdose*(finalbolusextpercent/100));  
			//finalcarbdose = finalcarbdose*(finalbolusnowpercent/100);
			newTotal = finalcarbdose+finalextdose+finalcorrdose+finalsuperdose;
			newNow = finalcarbdose+finalsuperdose+finalcorrdose;
			percentNow = Math.round((newNow/newTotal)*100);
			percentExt = 100-percentNow; //(finalextdose/newTotal)*100;   
		  }
		  else{
		  	newTotal = finalcarbdose+finalextdose+finalcorrdose+finalsuperdose;
		  	percentNow = Math.round(((finalcarbdose+finalcorrdose+finalsuperdose)/newTotal)*100);
		  	percentExt = 100-percentNow; //(finalextdose/newTotal)*100;    
		  }
		  if(finalextdose == 0){
			document.getElementById("submission_meal").innerHTML += "New total: "+newTotal.toFixed(2)+"<br/>";
		}
		else{
			var minutesToHours = finalextbolustime/60;
			  document.getElementById("submission_meal").innerHTML += "New total: "+newTotal.toFixed(2)+" ("+percentNow.toFixed(0)+"% / "+percentExt.toFixed(0)+"%)<br/>"+(finalcarbdose+finalcorrdose+finalsuperdose).toFixed(2)+" + "+finalextdose.toFixed(2)+" extended over "+minutesToHours+" hours.<br/>";
		}
	  } 
	      
	  var finalNonCorrNonExtDose = finalcarbdose+finalsuperdose+finalcorrdose;   
	  if(finalextdose > 0){ 
		  //Get time
		today = new Date(); // for now
		//Divide time
		var newDate = new Date(today);
		var extTimeIntervals = finalextbolustime/10.0;  
		  //finalextbolustime
		var insulinDiv = finalextdose/extTimeIntervals;
		var t;
		var UTCMonth;
		for (t = 0; t < parseInt(extTimeIntervals); t++){
			newDate.setTime(newDate.getTime() + 10*60*1000);
			//Format new time
			UTCtimeStr = newDate.toJSON();
			//Send fractional insulin amounts to NS
			postData({ "enteredBy":"BolusCalc","insulin":insulinDiv,"created_at":UTCtimeStr,"secret":secret },function(data){
			});	
		}
			     
	}
	if((finalNonCorrNonExtDose>0) || (netCarbs>0)){
	  if(finalNonCorrNonExtDose<0) { 
	  var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":netCarbs,"insulin":0,"eventType":eventType,"preBolus":prebolus,"secret":secret } );
	  }
	  else{	
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":netCarbs,"insulin":finalNonCorrNonExtDose,"eventType":eventType,"preBolus":prebolus,"secret":secret } );
	  }
          posting.done(function( data ) {
            document.getElementById("submission_meal").innerHTML += "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_meal").innerHTML += "Data NOT submitted &#x1F44E";  
	  });
	}
	if(finalcorrdose>0){
	  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":finalcorrdose,"eventType":"Correction Bolus","secret":secret } );
          posting2.done(function( data ) {
	    if((finalNonCorrNonExtDose==0) && (netCarbs==0)){ document.getElementById("submission_meal").innerHTML += "Data submitted &#x1F44D"; }
            //document.getElementById("submission_meal").innerHTML += " plus correction bolus";
          }); 
	  posting2.fail(function( data) {
	    document.getElementById("submission_meal").innerHTML += " WITHOUT correction bolus";  
	  });
	}
	if(finalsuperdose>0){
		  var posting3 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":"Temp Basal","notes":"Super bolus","secret":secret } );
		  // Put the results in a div
		  posting3.done(function( data ) {
		    if((finalNonCorrNonExtDose==0) && (netCarbs==0) && (finalcorrdose==0)){ document.getElementById("submission_meal").innerHTML += "Data submitted &#x1F44D"; }
		    //document.getElementById("submission_meal").innerHTML += " plus super bolus temp basal.";
		  }); 
		  posting3.fail(function( data) {
		    document.getElementById("submission_meal").innerHTML += ", WITHOUT super bolus temp basal.";  
		  });
	  }  
        });
	$("#correctionform").submit(function( event ) {
          // Stop form from submitting normally
          event.preventDefault();
	  cleardivs("Correction");
          // Get some values from elements on the page
	  var $form = $( this ),
	    corrdose = $form.find( "input[id='corrdose']" ).val();
          // Send the data using post 
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":corrdose,"eventType":"Correction Bolus","secret":secret } );
          // Put the results in a div
          posting.done(function( data ) {
            document.getElementById("submission_correction").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_correction").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
	  if(corrdose == newBolusCorr){     
		  if(newBolusSuper>0){
			  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":60,"percent":-100,"eventType":"Temp Basal","notes":basalnotes,"secret":secret } );
			  // Put the results in a div
			  posting2.done(function( data ) {
			    document.getElementById("submission_correction").innerHTML += " plus super bolus temp basal.";
			  }); 
			  posting2.fail(function( data) {
			    document.getElementById("submission_correction").innerHTML += " WITHOUT super bolus temp basal.";  
			  });
		  }
	  }
        });
	      
	$("#carbsonlyform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("Carbs");
	  var $form = $( this ),
	    corrCarbs = $form.find( "input[id='corrCarbs']" ).val();
	  eventType = "Carb Correction";
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","carbs":corrCarbs,"eventType":eventType,"notes":"Low","secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_carbsonly").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_carbsonly").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
	      
	$("#tempbasalform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("N/A");
	  var $form = $( this ),
	    basald = $form.find( "input[id='basalduration']" ).val(),
	    basalp = $form.find( "input[id='basalpercent']" ).val();
	  if(eventType == '') { eventType = "Temp Basal"; }
          var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":basald,"percent":basalp,"eventType":eventType,"notes":basalnotes,"secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_tempbasal").innerHTML = "Data submitted &#x1F44D";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_tempbasal").innerHTML = "Data NOT submitted &#x1F44E";  
	  });
        });
	$("#exerciseform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("Exercise");
	  var $form = $( this ),
	    exercisetime = $form.find( "input[id='exerciseduration']" ).val();
	  var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","duration":exercisetime,"notes":exerciseType,"eventType":eventType,"secret":secret } );
          posting.done(function( data ) {
            document.getElementById("submission_exercise").innerHTML += "Data submitted &#x1F44D ";
          }); 
	  posting.fail(function( data) {
	    document.getElementById("submission_exercise").innerHTML += "Data NOT submitted &#x1F44E ";  
	  });
        });   
	$("#removepumpform").submit(function( event ) {
          event.preventDefault();
	  cleardivs("N/A");
	  var $form = $( this ),
	    pumpoffduration = $form.find( "input[id='pumpoffduration']" ).val();
	  var insulinreco = (pumpoffduration/60)*currBasal;
	  var addToReco = '';
	  if(currBG >= BGgoal){
		  var posting = $.post( treatmentsURL, { "enteredBy":"BolusCalc","insulin":insulinreco,"notes":"Shower","secret":secret } );
		  posting.done(function( data ) {
		    document.getElementById("submission_removepump").innerHTML = "Data submitted &#x1F44D Bolus "+insulinreco+" units before removing. ";
		  }); 
		  posting.fail(function( data) {
		    document.getElementById("submission_removepump").innerHTML = "Data NOT submitted &#x1F44E Bolus "+insulinreco+" units before removing. ";  
		  });
	  }
	  else{
		  addToReco = " No bolus required.";
	  }
	  var posting2 = $.post( treatmentsURL, { "enteredBy":"BolusCalc","eventType":"Temp Basal","duration":pumpoffduration,"notes":"Shower","secret":secret } );
          posting2.done(function( data ) {
            document.getElementById("submission_removepump").innerHTML += "Temp basal set."+addToReco;
          }); 
	  posting2.fail(function( data) {
	    document.getElementById("submission_removepump").innerHTML += "Temp basal NOT set."+addToReco;  
	  });
        });
      
      });
      
    </script>
    
  </head>
  <body>

    <div id="statusdiv" class="alt1">  
    <b>Current Stats</b><br/>	  
    <div id="resultsBG">BG: --<br/>BG Trend: --<br/>30 min delta: --<br/>60 min delta: --<br/>Time since last meal/snack: --<br/>IOB (food): --
	    </div>
	  </div>
	  
    <div id="mealdiv" class="alt2">
    <b>Meal or Snack</b><br/>
    <form id="mealform">	    
      Load meal:<br/>
	    <select id="prebolus">
	  <option value="0" selected="selected">0</option>
	  <option value="5">5</option>
		<option value="10">10</option>
		<option value="15">15</option>
		<option value="20">20</option>
		<option value="25">25</option>
		<option value="30">30</option>
	</select> Carb time<br/>
	    <div class="columnwrap">
	    <div class="leftcolumn">
		    <input id="BreakfastButton" type="button" value="Breakfast" /><br/>
		    <input id="LunchButton" type="button" value="Lunch" /><br/>
		    <input id="DinnerButton" type="button" value="Dinner" />
	    </div>
	    <div class="rightcolumn">
		   <input id="MornSnackButton" type="button" value="Morning Snack" /><br/>
		    <input id="AftSnackButton" type="button" value="Afternoon Snack" /><br/>
		    <input id="EveSnackButton" type="button" value="Evening Snack" />
	    </div>
	    </div>
	    <br/>    
      Results:<br/>
      <input type="number" step="0.1" id="carbs" placeholder="Grams" min="0" value="0" /> Carbs<br/>
      <input type="number" step="0.1" id="fat" placeholder="Grams" min="0" value="0" /> Fat<br/>
      <input type="number" step="0.1" id="protein" placeholder="Grams" min="0" value="0" /> Protein<br/>
      <input type="number" step="0.1" id="fiber" placeholder="Grams" min="0" value="0" /> Fiber<br/><br/>
	
      <!--<input type="button" id="TestButton" value="Process Test Data" /><br/><br/>-->
	<input type="button" id="suggest_meal" value="Manual entry" /><br/>
	    <div id="results_meal"></div>
	    <div id="results_mealdose">
		<input type="number" step="0.01" id="carbdose_meal" min="0" value="0"/> Carbs <input type="button" id="carbdose_clear" value="Clear" class="clear" />
		<br/><input type="number" step="0.01" id="extdose_meal" min="0" value="0"/> Extended <input type="button" id="extdose_clear" value="Clear" class="clear" />
		<br/><input type="number" step="0.01" id="corrdose_meal" value="0"/> Correction <input type="button" id="corrdose_clear" value="Clear" class="clear" />
		<br/><input type="number" step="0.01" id="super_meal" min="0" value="0"/> Super <input type="button" id="superdose_clear" value="Clear" class="clear" />
		<br/><input type="number" step="1" id="bolusnow_meal" min="0" value="100" style="width: 22%;" />%<input type="number" step="1" id="bolusext_meal" min="0" value="0" style="width: 22%;" />% Combo split <input type="button" id="combosplit_clear" value="Clear" class="clear" />  
		<br/><select id="extBolusTime">
		<option value="N/A">N/A</option>    
	  	<option value="30">30 mins</option>
	  	<option value="60">1 hr</option>
		<option value="90">1.5 hrs</option>
		<option value="120" selected="selected">2 hrs</option>
		<option value="150">2.5 hrs</option>
		<option value="180">3 hrs</option>
	</select> Ext bolus time<br/>    
		<input type="submit" id="submit_meal" value="Submit meal/snack" /><br/>
	    </div> 
    </form>
    <div id="submission_meal"></div>
    
	  </div>

    <div id="correctiondiv" class="alt1">	  
    <b>Correction Only</b><br/>	  
    <form id="correctionform">
	    <input type="number" id="corrdose" step="0.01" min="0" /> Units<br/>
	    <input type="button" id="CorrOnly" value="Suggest correction" /><br/>
	    <input type="submit" id="submit_correction" value="Submit correction" />
	  </form>
	  <div id="submission_correction"></div>
    <div id="results_correction"></div>
	  </div>
	  
	  <div id="carbsdiv" class="alt2">
<b>Carbs Only</b><br/>	
	<form id="carbsonlyform">
	<input type="number" step="0.1" id="corrCarbs" placeholder="Carbs in grams" min="0" value="8"/> Carbs<br/>
	<input type="button" id="CarbsOnly" value="Suggest carbs" /><br/>
	<input type="submit" id="submit_carbs" value="Submit carbs" /><br/>
	  </form>
	  <div id="submission_carbsonly"></div>
	  <div id="results_carbs"></div>
	  </div>
	  
	  <div id="tempbasaldiv" class="alt1">
	  <b>Temp Basal</b><br/>
	<form id="tempbasalform">
	<input type="number" id="basalduration" placeholder="Minutes" min="0" /> Duration<br/>
      	<input type="number" id="basalpercent" placeholder="Basal change in %" min="-100" /> % Change<br/>
		<div class="columnwrap">
		<div class="leftcolumn">
		<input type="button" id="EngineBraking" value="Engine braking" /><br/>
		<input type="submit" id="submit_tempbasal" value="Submit" />
		</div>
		<div class="rightcolumn">
		<input type="button" id="SuperBolus" value="Super bolus" />
		</div>
		</div>
	  </form>
	  <div id="submission_tempbasal"></div>
	  </div>
	  
	  <div id="exercisediv" class="alt2">
	  <b>Exercise</b><br/>	
	<form id="exerciseform">
	<input type="number" id="exerciseduration" placeholder="Minutes" min="0" /> Duration<br/>
		<div class="columnwrap">
		<div class="leftcolumn">
		<input type="button" id="Dance" value="Dance" /><br/>
		<input type="submit" id="ExerciseSubmit" value="Submit" />
		</div>
		<div class="rightcolumn">
			<input type="button" id="Yoga" value="Yoga" /><br/>
			<input type="button" id="Other" value="Other" />
		</div>
		</div>
	
	  </form>
	  <div id="submission_exercise"></div>
	  </div>
	  
	  <div id="removepumpdiv" class="alt1">
	   <b>Remove Pump</b><br/>	
	<form id="removepumpform">
	<input type="number" id="pumpoffduration" placeholder="Minutes" min="0" /> Duration<br/>
	<input type="submit" id="RemovePump" value="Submit" />
	  </form>
	  <div id="submission_removepump"></div>
	  </div>
	  
	  <div id="errors"></div>

  </body>
</html>
