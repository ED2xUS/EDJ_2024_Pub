<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Bolus Calc Advanced</title>
    
    <link rel="shortcut icon" href="https://beetusbot.herokuapp.com/images/favicon.ico">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 

    <style>
      body {padding: 30px 30px 30px 30px;}
      input[type=submit] {width: 50%;}
      input[type=number] {width: 50%;}
      input[type=text] {width: 100%;}
      form {max-width: 300px;}
    </style>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!--<script src="https://beetusbot.herokuapp.com/js/bootstrap.min.js"></script>-->
    <script type="text/javascript" src="https://beetusbot.herokuapp.com/js/jquery.ajax-cross-origin.min.js"></script>
    
    <script>
        
      (function() { // Begin scoping function
        
      var today = new Date(); // for now
      var hours = today.getHours(); 
      if (hours < 10) { hours = "0"+hours; }
      var minutes = today.getMinutes(); 
      if (minutes < 10) { minutes = "0"+minutes; }
      var timeStr = hours+":"+minutes;
      
      var currBG = 0;
      var currProfile = "";
      var currBasal = 0.0;
      var currSens = 0.0;
      var currCarbRatio = 0.0;
      
      function getCustomJSON(URL, type, callback){
        
         $.getJSON(URL,function(data){
           
           if(type == "profile") {
             currProfile = data[0].defaultProfile;
             //console.log("Type of data: " + typeof (data[0].store[currProfile].basal[1].time));
             //console.log("Length of object: " + Object.keys(basalProfile).length);
             
             // Define current basal 
             var basalProfile = data[0].store[currProfile].basal;  
             if(timeStr > basalProfile[Object.keys(basalProfile).length-1].time){
                 currBasal = parseFloat(basalProfile[Object.keys(basalProfile).length-1].value);
               }
             else{
               for (i = 1; i < Object.keys(basalProfile).length; i++){
                 //console.log("Basal profile time/value "+i+ ": "+basalProfile[i].time+ " / "+basalProfile[i].value);
                 if (timeStr < basalProfile[i].time) {
                   currBasal = parseFloat(basalProfile[i-1].value);
                   break; 
                 }
               }
             }
             // Define current sensitivity
             var sensProfile = data[0].store[currProfile].sens;  
             if(timeStr > sensProfile[Object.keys(sensProfile).length-1].time){
                 currSens = parseFloat(sensProfile[Object.keys(sensProfile).length-1].value);
               }
             else{
               for (i = 1; i < Object.keys(sensProfile).length; i++){
                 if (timeStr < sensProfile[i].time) {
                   currSens = parseFloat(sensProfile[i-1].value);
                   break; 
                 }
               }
             }
             // Define current carb ratio
             var ratioProfile = data[0].store[currProfile].carbratio;  
             if(timeStr > ratioProfile[Object.keys(ratioProfile).length-1].time){
                 currCarbRatio = parseFloat(ratioProfile[Object.keys(ratioProfile).length-1].value);
               }
             else{
               for (i = 1; i < Object.keys(ratioProfile).length; i++){
                 if (timeStr < ratioProfile[i].time) {
                   currCarbRatio = parseFloat(ratioProfile[i-1].value);
                   break; 
                 }
               }
             }
             // Return values
             callback(currProfile,currBasal,currSens,currCarbRatio);
           }
           if(type == "BG") {
             // Define current BG
             currBG = parseInt(data[0].sgv);
             callback(currBG);
           }
          });
      }

      getCustomJSON("https://beetusbot.herokuapp.com/api/v1/profile.json","profile",function(returndata){
        document.getElementById("basal").value = currBasal;
        document.getElementById("sensitivity").value = currSens;
        document.getElementById("carbRatio").value = currCarbRatio; 
      });
        
      getCustomJSON("https://beetusbot.herokuapp.com/api/v1/entries.json?count=1","BG",function(returndata){      
        document.getElementById("BG").value = currBG;
      });

      var mealCode = '';  
      var carbs = 0;
      var fat = 0;
      var protein = 0;
      var fiber = 0;
      function getMealData(mealName, callback){
         $.ajax({
            url: 'http://www.myfitnesspal.com/food/diary/oboe_girl4',
            method: 'GET',
            dataType: 'html',
            crossOrigin: true,
            success: function(data){
               //console.log(data);
               if(mealName == "Breakfast"){
                var breakfastStart = data.indexOf('<tr class="meal_header">');
                //console.log("Breakfast starting index: "+breakfastStart);
                var lunchStart = data.indexOf('<tr class="meal_header">',breakfastStart+24);
                //console.log("Breakfast ending index: "+lunchStart);
                mealCode = data.substring(breakfastStart,lunchStart);
               //console.log("Breakfast code: "+breakfastCode);
               callback(mealCode);
               
            },
            error: function(data){
               document.getElementById("mfp").innerHTML += "MyFitnessPal data could not be pulled";
            }
         }); 
      }
        
      getMealData("Breakfast",function(returndata){
        //var breakfastTotalsRef = data.indexOf('<div id="meals_copy_to_0" class="quick_add_meals_list hidden">',breakfastStart);
        //var breakfastCals = data.indexOf('<td>',breakfastTotalsRef)
        document.getElementById("mfp").innerHTML += mealCode;   
      });
        
      })();         // End scoping function
      
    </script>
    
  </head>
  <body>

    <b>Test form</b>
    <form name="testform" id="testform">
      <input type=number name="BG" id="BG" placeholder="BG in mg/dL" min="0" /> BG<br>
      <input type=number step=0.1 name="carbs" id="carbs" placeholder="Carbs in grams" min="0" /> Carbs<br>
      <input type=number step=0.1 name="fat" id="fat" placeholder="Fat in grams" min="0" /> Fat<br>
      <input type=number step=0.1 name="protein" id="protein" placeholder="Protein in grams" min="0" /> Protein<br>
      <input type=number step=0.1 name="fiber" id="fiber" placeholder="Fiber in grams" min="0" /> Fiber<br>
      <input type=number step=0.01 name="corrIOB" id="corrIOB" placeholder="Units" min="0" /> Correction IOB<br>
      <input type=number step=0.01 name="basal" id="basal" placeholder="Units/hr" min="0" /> Basal units/hr<br>
      <input type=number name="sensitivity" id="sensitivity" placeholder="mg/dL per unit" min="0" /> Sensitivity<br>
      <input type=number name="carbRatio" id="carbRatio" placeholder="Carbs per unit" min="0" /> Carb Ratio<br>
      <input type=submit name="submit" id="submit" value="Submit" /><br>
    </form>
    <br>
    
    <div id="results"></div>
    
    <div id="mfp"></div>
    
    <script>
      //console.log("Page loaded");
      $("#testform").submit(function(e) {
          e.preventDefault();
          var bg = parseFloat($("#BG").val());
          var carbs = parseFloat($("#carbs").val());
          var fat = parseFloat($("#fat").val());
          var protein = parseFloat($("#protein").val());
          var fiber = parseFloat($("#fiber").val());
          var corrIOB = parseFloat($("#corrIOB").val());
          var basal = parseFloat($("#basal").val());
          var sensitivity = parseFloat($("#sensitivity").val());
          var carbRatio = parseFloat($("#carbRatio").val());
          var CU = (carbs/10.0);
          document.getElementById("results").innerHTML = "CU: "+ CU+ "<br/>";
          //console.log("CU: "+ CU);
          var FPU = (protein*4.0+fat*9.0)/100.0;
          document.getElementById("results").innerHTML += "FPU: "+ FPU+ "<br/>";
          //console.log("FPU: "+ FPU);
          var IRFactor = (10.0/carbRatio);
          document.getElementById("results").innerHTML += "IRFactor: "+ IRFactor+ "<br/>";
          //console.log("IRFactor: "+ IRFactor);
          var CDI = (CU + FPU) * IRFactor;
          document.getElementById("results").innerHTML += "CDI: "+ CDI+ "<br/>";
          //console.log("CDI: "+ CDI);
          var CU_perc = CU / (CU + FPU);
          document.getElementById("results").innerHTML += "CU_perc: "+ CU_perc+ "<br/>";
          //console.log("CU_perc: "+ CU_perc);
          var correction = ((bg - 100)/sensitivity) - corrIOB;
          document.getElementById("results").innerHTML += "Correction: "+ correction+ "<br/>";
          //console.log("Correction: "+ correction);
          if (CU_perc < 0.2) { var NB = 0; }
          else if (CU_perc >= 0.2 && CU_perc <= 0.8) { var NB = CU * IRFactor * (1 - correction); }
          else { var NB = CU * IRFactor; }
          document.getElementById("results").innerHTML += "NB: "+ NB+ "<br/>";
          //console.log("NB: "+ NB);
          if ((FPU < 1.0) || ((FPU >= 1.0) && (CU_perc > 0.8))) { var SB = 0; }
          else if ((FPU >= 1.0) && (CU_perc < 0.2)) { var SB = FPU * IRFactor; }
          else if ((FPU >= 1.0) && (CU_perc >= 0.2) && (CU_perc <= 0.8) ) { var SB = FPU * IRFactor * (1 - correction); }
          document.getElementById("results").innerHTML += "SB: "+ SB+ "<br/>";
          //console.log("SB: "+ SB);
          if ((FPU < 1.0) || (CU_perc > 0.8)) { var T_hours = 0; }
          else if ((FPU >= 1.0) && (FPU < 2.0)) { var T_hours = 3; }
          else if ((FPU >= 2.0) && (FPU < 3.0)) { var T_hours = 4; }
          else if ((FPU >= 3.0) && (FPU < 4.0)) { var T_hours = 5; }
          else { var T_hours = 8; }
          var T_mins = T_hours * 60;
          document.getElementById("results").innerHTML += "T_hours: "+ T_hours+ "<br/>";
          //console.log("T_hours: "+ T_hours);
          console.log("Function ran");
          return false;
      });
      
    </script>
      
  </body>
</html>
